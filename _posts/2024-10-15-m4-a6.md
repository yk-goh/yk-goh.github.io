# bank 데이터를 사용하여 CFRL 구하기
> immutable_features, ranges and C(condition)

## 0. import libraries and data


```python
# !pip install xgboost
```


```python
# !pip install alibi
```


```python
import os
import numpy as np
import pandas as pd
from copy import deepcopy
from typing import List, Tuple, Dict, Callable
import tensorflow as tf
import tensorflow.keras as keras
from sklearn.compose import ColumnTransformer
from sklearn.preprocessing import StandardScaler, OneHotEncoder, OrdinalEncoder
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, f1_score
from sklearn.ensemble import RandomForestClassifier
from sklearn.tree import DecisionTreeClassifier
from sklearn.linear_model import LogisticRegression
from alibi.explainers import CounterfactualRLTabular, CounterfactualRL
from alibi.datasets import fetch_adult
from alibi.explainers.backends.cfrl_tabular import get_he_preprocessor, apply_category_mapping

np.set_printoptions(precision=3, suppress=True)
```


```python
from google.colab import files

uploaded = files.upload()  # Opens a dialogue to select the file from your local system
```



     <input type="file" id="files-45368141-f18a-4beb-b822-f2d0873120e8" name="files[]" multiple disabled
        style="border:none" />
     <output id="result-45368141-f18a-4beb-b822-f2d0873120e8">
      Upload widget is only available when the cell has been executed in the
      current browser session. Please rerun this cell to enable.
      </output>
      <script>// Copyright 2017 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Helpers for google.colab Python module.
 */
(function(scope) {
function span(text, styleAttributes = {}) {
  const element = document.createElement('span');
  element.textContent = text;
  for (const key of Object.keys(styleAttributes)) {
    element.style[key] = styleAttributes[key];
  }
  return element;
}

// Max number of bytes which will be uploaded at a time.
const MAX_PAYLOAD_SIZE = 100 * 1024;

function _uploadFiles(inputId, outputId) {
  const steps = uploadFilesStep(inputId, outputId);
  const outputElement = document.getElementById(outputId);
  // Cache steps on the outputElement to make it available for the next call
  // to uploadFilesContinue from Python.
  outputElement.steps = steps;

  return _uploadFilesContinue(outputId);
}

// This is roughly an async generator (not supported in the browser yet),
// where there are multiple asynchronous steps and the Python side is going
// to poll for completion of each step.
// This uses a Promise to block the python side on completion of each step,
// then passes the result of the previous step as the input to the next step.
function _uploadFilesContinue(outputId) {
  const outputElement = document.getElementById(outputId);
  const steps = outputElement.steps;

  const next = steps.next(outputElement.lastPromiseValue);
  return Promise.resolve(next.value.promise).then((value) => {
    // Cache the last promise value to make it available to the next
    // step of the generator.
    outputElement.lastPromiseValue = value;
    return next.value.response;
  });
}

/**
 * Generator function which is called between each async step of the upload
 * process.
 * @param {string} inputId Element ID of the input file picker element.
 * @param {string} outputId Element ID of the output display.
 * @return {!Iterable<!Object>} Iterable of next steps.
 */
function* uploadFilesStep(inputId, outputId) {
  const inputElement = document.getElementById(inputId);
  inputElement.disabled = false;

  const outputElement = document.getElementById(outputId);
  outputElement.innerHTML = '';

  const pickedPromise = new Promise((resolve) => {
    inputElement.addEventListener('change', (e) => {
      resolve(e.target.files);
    });
  });

  const cancel = document.createElement('button');
  inputElement.parentElement.appendChild(cancel);
  cancel.textContent = 'Cancel upload';
  const cancelPromise = new Promise((resolve) => {
    cancel.onclick = () => {
      resolve(null);
    };
  });

  // Wait for the user to pick the files.
  const files = yield {
    promise: Promise.race([pickedPromise, cancelPromise]),
    response: {
      action: 'starting',
    }
  };

  cancel.remove();

  // Disable the input element since further picks are not allowed.
  inputElement.disabled = true;

  if (!files) {
    return {
      response: {
        action: 'complete',
      }
    };
  }

  for (const file of files) {
    const li = document.createElement('li');
    li.append(span(file.name, {fontWeight: 'bold'}));
    li.append(span(
        `(${file.type || 'n/a'}) - ${file.size} bytes, ` +
        `last modified: ${
            file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() :
                                    'n/a'} - `));
    const percent = span('0% done');
    li.appendChild(percent);

    outputElement.appendChild(li);

    const fileDataPromise = new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve(e.target.result);
      };
      reader.readAsArrayBuffer(file);
    });
    // Wait for the data to be ready.
    let fileData = yield {
      promise: fileDataPromise,
      response: {
        action: 'continue',
      }
    };

    // Use a chunked sending to avoid message size limits. See b/62115660.
    let position = 0;
    do {
      const length = Math.min(fileData.byteLength - position, MAX_PAYLOAD_SIZE);
      const chunk = new Uint8Array(fileData, position, length);
      position += length;

      const base64 = btoa(String.fromCharCode.apply(null, chunk));
      yield {
        response: {
          action: 'append',
          file: file.name,
          data: base64,
        },
      };

      let percentDone = fileData.byteLength === 0 ?
          100 :
          Math.round((position / fileData.byteLength) * 100);
      percent.textContent = `${percentDone}% done`;

    } while (position < fileData.byteLength);
  }

  // All done.
  yield {
    response: {
      action: 'complete',
    }
  };
}

scope.google = scope.google || {};
scope.google.colab = scope.google.colab || {};
scope.google.colab._files = {
  _uploadFiles,
  _uploadFilesContinue,
};
})(self);
</script> 


    Saving bank.csv to bank.csv



```python
df = pd.read_csv('bank.csv', sep=';')
```

## 1. 데이터 확인
bank 데이터셋은 은행의 마케팅캠페인 정보와 고객이 해당 캠페인 결과 은행의 정기예금 상품에 가입했는지를 기록한 데이터셋이다. 16개의 특성변수가 있으며 목적변수는 y이다. 


```python
df.head()
```





  <div id="df-ab264133-71e8-4e2d-aaa3-b646f9d2726d" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>balance</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>day</th>
      <th>month</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>poutcome</th>
      <th>y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>unemployed</td>
      <td>married</td>
      <td>primary</td>
      <td>no</td>
      <td>1787</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>19</td>
      <td>oct</td>
      <td>79</td>
      <td>1</td>
      <td>-1</td>
      <td>0</td>
      <td>unknown</td>
      <td>no</td>
    </tr>
    <tr>
      <th>1</th>
      <td>33</td>
      <td>services</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>4789</td>
      <td>yes</td>
      <td>yes</td>
      <td>cellular</td>
      <td>11</td>
      <td>may</td>
      <td>220</td>
      <td>1</td>
      <td>339</td>
      <td>4</td>
      <td>failure</td>
      <td>no</td>
    </tr>
    <tr>
      <th>2</th>
      <td>35</td>
      <td>management</td>
      <td>single</td>
      <td>tertiary</td>
      <td>no</td>
      <td>1350</td>
      <td>yes</td>
      <td>no</td>
      <td>cellular</td>
      <td>16</td>
      <td>apr</td>
      <td>185</td>
      <td>1</td>
      <td>330</td>
      <td>1</td>
      <td>failure</td>
      <td>no</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30</td>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>1476</td>
      <td>yes</td>
      <td>yes</td>
      <td>unknown</td>
      <td>3</td>
      <td>jun</td>
      <td>199</td>
      <td>4</td>
      <td>-1</td>
      <td>0</td>
      <td>unknown</td>
      <td>no</td>
    </tr>
    <tr>
      <th>4</th>
      <td>59</td>
      <td>blue-collar</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>0</td>
      <td>yes</td>
      <td>no</td>
      <td>unknown</td>
      <td>5</td>
      <td>may</td>
      <td>226</td>
      <td>1</td>
      <td>-1</td>
      <td>0</td>
      <td>unknown</td>
      <td>no</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-ab264133-71e8-4e2d-aaa3-b646f9d2726d')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-ab264133-71e8-4e2d-aaa3-b646f9d2726d button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-ab264133-71e8-4e2d-aaa3-b646f9d2726d');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-53700904-7a59-4e2c-80b8-d2e5622b361a">
  <button class="colab-df-quickchart" onclick="quickchart('df-53700904-7a59-4e2c-80b8-d2e5622b361a')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-53700904-7a59-4e2c-80b8-d2e5622b361a button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>




지난주와 마찬가지로 목적변수의 분포가 약 8:1로 ‘no’가 더 많은 불균형 데이터임을 확인하고,


```python
df['y'].value_counts()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>y</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>no</th>
      <td>4000</td>
    </tr>
    <tr>
      <th>yes</th>
      <td>521</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> int64</label>



범주형 특성변수와 실수형 특성변수가 무엇인지 파악한다. df.describe(include=’all’)을 실행하면 범주형 변수에 대해서는 범주값의 개수(unique)와 각 범주에서 가장 빈도가 높은 범주값과 그 빈도를 보여주고 실수형 변수에 대해서는 요약통계량을 출력한다. 특성변수 중 age(연령), balance(잔고), day(날짜), duration(최근 연락의 통화시간(초 단위)), campaign(이 캠페인으로 연락한 횟수), pdays(지난 캠페인 연락으로부터 경과일 수), previous(이 캠페인 이전에 연락한 횟수)는 실수형 특성변수이다.


```python
df.describe(include='all')
```





  <div id="df-f1a23967-b52a-42bf-9d99-d57cd9f32b26" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>balance</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>day</th>
      <th>month</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>poutcome</th>
      <th>y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>4521.000000</td>
      <td>4521</td>
      <td>4521</td>
      <td>4521</td>
      <td>4521</td>
      <td>4521.000000</td>
      <td>4521</td>
      <td>4521</td>
      <td>4521</td>
      <td>4521.000000</td>
      <td>4521</td>
      <td>4521.000000</td>
      <td>4521.000000</td>
      <td>4521.000000</td>
      <td>4521.000000</td>
      <td>4521</td>
      <td>4521</td>
    </tr>
    <tr>
      <th>unique</th>
      <td>NaN</td>
      <td>12</td>
      <td>3</td>
      <td>4</td>
      <td>2</td>
      <td>NaN</td>
      <td>2</td>
      <td>2</td>
      <td>3</td>
      <td>NaN</td>
      <td>12</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4</td>
      <td>2</td>
    </tr>
    <tr>
      <th>top</th>
      <td>NaN</td>
      <td>management</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>NaN</td>
      <td>yes</td>
      <td>no</td>
      <td>cellular</td>
      <td>NaN</td>
      <td>may</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>unknown</td>
      <td>no</td>
    </tr>
    <tr>
      <th>freq</th>
      <td>NaN</td>
      <td>969</td>
      <td>2797</td>
      <td>2306</td>
      <td>4445</td>
      <td>NaN</td>
      <td>2559</td>
      <td>3830</td>
      <td>2896</td>
      <td>NaN</td>
      <td>1398</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3705</td>
      <td>4000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>41.170095</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1422.657819</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>15.915284</td>
      <td>NaN</td>
      <td>263.961292</td>
      <td>2.793630</td>
      <td>39.766645</td>
      <td>0.542579</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>std</th>
      <td>10.576211</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3009.638142</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8.247667</td>
      <td>NaN</td>
      <td>259.856633</td>
      <td>3.109807</td>
      <td>100.121124</td>
      <td>1.693562</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>min</th>
      <td>19.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-3313.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.000000</td>
      <td>NaN</td>
      <td>4.000000</td>
      <td>1.000000</td>
      <td>-1.000000</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>33.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>69.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>9.000000</td>
      <td>NaN</td>
      <td>104.000000</td>
      <td>1.000000</td>
      <td>-1.000000</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>39.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>444.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>16.000000</td>
      <td>NaN</td>
      <td>185.000000</td>
      <td>2.000000</td>
      <td>-1.000000</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>49.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1480.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>21.000000</td>
      <td>NaN</td>
      <td>329.000000</td>
      <td>3.000000</td>
      <td>-1.000000</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>max</th>
      <td>87.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>71188.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>31.000000</td>
      <td>NaN</td>
      <td>3025.000000</td>
      <td>50.000000</td>
      <td>871.000000</td>
      <td>25.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-f1a23967-b52a-42bf-9d99-d57cd9f32b26')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-f1a23967-b52a-42bf-9d99-d57cd9f32b26 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-f1a23967-b52a-42bf-9d99-d57cd9f32b26');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-e47a01be-9adb-4323-baf1-5c18957393ad">
  <button class="colab-df-quickchart" onclick="quickchart('df-e47a01be-9adb-4323-baf1-5c18957393ad')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-e47a01be-9adb-4323-baf1-5c18957393ad button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>




## 2. 전처리

### 2.1 day 변수 범주화


```python
def get_day_cat(day):
  if day <= 10:
    day_cat = 'early'
  elif day <= 20:
    day_cat = 'mid'
  else:
    day_cat = 'late'
  return day_cat

df['day_cat'] = df['day'].apply(get_day_cat)
df.head()
```





  <div id="df-76a442ef-930f-42a6-b5e2-89af4ad79a0f" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>balance</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>day</th>
      <th>month</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>poutcome</th>
      <th>y</th>
      <th>day_cat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30</td>
      <td>unemployed</td>
      <td>married</td>
      <td>primary</td>
      <td>no</td>
      <td>1787</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>19</td>
      <td>oct</td>
      <td>79</td>
      <td>1</td>
      <td>-1</td>
      <td>0</td>
      <td>unknown</td>
      <td>no</td>
      <td>mid</td>
    </tr>
    <tr>
      <th>1</th>
      <td>33</td>
      <td>services</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>4789</td>
      <td>yes</td>
      <td>yes</td>
      <td>cellular</td>
      <td>11</td>
      <td>may</td>
      <td>220</td>
      <td>1</td>
      <td>339</td>
      <td>4</td>
      <td>failure</td>
      <td>no</td>
      <td>mid</td>
    </tr>
    <tr>
      <th>2</th>
      <td>35</td>
      <td>management</td>
      <td>single</td>
      <td>tertiary</td>
      <td>no</td>
      <td>1350</td>
      <td>yes</td>
      <td>no</td>
      <td>cellular</td>
      <td>16</td>
      <td>apr</td>
      <td>185</td>
      <td>1</td>
      <td>330</td>
      <td>1</td>
      <td>failure</td>
      <td>no</td>
      <td>mid</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30</td>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>1476</td>
      <td>yes</td>
      <td>yes</td>
      <td>unknown</td>
      <td>3</td>
      <td>jun</td>
      <td>199</td>
      <td>4</td>
      <td>-1</td>
      <td>0</td>
      <td>unknown</td>
      <td>no</td>
      <td>early</td>
    </tr>
    <tr>
      <th>4</th>
      <td>59</td>
      <td>blue-collar</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>0</td>
      <td>yes</td>
      <td>no</td>
      <td>unknown</td>
      <td>5</td>
      <td>may</td>
      <td>226</td>
      <td>1</td>
      <td>-1</td>
      <td>0</td>
      <td>unknown</td>
      <td>no</td>
      <td>early</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-76a442ef-930f-42a6-b5e2-89af4ad79a0f')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-76a442ef-930f-42a6-b5e2-89af4ad79a0f button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-76a442ef-930f-42a6-b5e2-89af4ad79a0f');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-033b1b21-7a56-4029-89c7-12e5ec9cf081">
  <button class="colab-df-quickchart" onclick="quickchart('df-033b1b21-7a56-4029-89c7-12e5ec9cf081')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-033b1b21-7a56-4029-89c7-12e5ec9cf081 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>




### 2.2 특성변수의 순서 변경
전처리 과정의 용이성을 위해 범주형 특성변수끼리, 실수형 특성변수끼리 모이도록 순서를 변경한다. 범주형 특성변수 열 개가 앞부분에, 실수형 특성변수 여섯 개는 뒷부분에 위치하도록 한다. 


```python
df_cat = df[['job', 'marital', 'education', 'default', 'housing', 'loan', 'contact', 'month', 'poutcome', 'day_cat']]
df_num = df[['age', 'balance', 'duration', 'campaign', 'pdays', 'previous']]
df_X = pd.concat([df_cat, df_num], axis=1)
df_target = df[['y']]
```

### 2.3 category map 생성
모든 특성변수명을 담은 리스트와 범주형 특성변수의 이름과 인덱스를 담은 리스트, 실수형 특성변수의 이름과 인덱스를 담은 리스트를 각각 생성한다. 범주형 특성변수 인덱스 리스트를 alibi.utils 라이브러리가 제공하는 gen_category_map 함수에 넘겨 category map을 생성한다. category map은 추후 4.에서 Heterogeneous preprocessor를 생성할 때 필요하다. 


```python
from alibi.utils import gen_category_map

feature_names = list(df_X.columns)
categorical_ids = list(range(10))
category_map = gen_category_map(data = df_X.to_numpy(), categorical_columns = categorical_ids)
category_map
```




    {0: ['admin.',
      'blue-collar',
      'entrepreneur',
      'housemaid',
      'management',
      'retired',
      'self-employed',
      'services',
      'student',
      'technician',
      'unemployed',
      'unknown'],
     1: ['divorced', 'married', 'single'],
     2: ['primary', 'secondary', 'tertiary', 'unknown'],
     3: ['no', 'yes'],
     4: ['no', 'yes'],
     5: ['no', 'yes'],
     6: ['cellular', 'telephone', 'unknown'],
     7: ['apr',
      'aug',
      'dec',
      'feb',
      'jan',
      'jul',
      'jun',
      'mar',
      'may',
      'nov',
      'oct',
      'sep'],
     8: ['failure', 'other', 'success', 'unknown'],
     9: ['early', 'late', 'mid']}




```python
categorical_names = [feature_names[i] for i in category_map.keys()]
categorical_names
```




    ['job',
     'marital',
     'education',
     'default',
     'housing',
     'loan',
     'contact',
     'month',
     'poutcome',
     'day_cat']



위 프로그램에서 생성한 categorical_names를 출력하면 ['job', 'marital', 'education', 'default', 'housing', 'loan', 'contact', month', 'poutcome', 'day_cat']이 출력되어 제대로 생성되었음을 확인할 수 있다.


```python
numerical_names = list(set(feature_names) - set(categorical_names))
# numerical_names = [name for i, name in enumerate(feature_names) if i not in category_map.keys()]
numerical_names
```




    ['campaign', 'balance', 'pdays', 'duration', 'previous', 'age']




```python
numerical_ids = [i for i in range(len(feature_names)) if i not in category_map.keys()]
numerical_ids
```




    [10, 11, 12, 13, 14, 15]



### 2.4 ordinal encoding
범주형 특성변수의 변수값이 범주가 아닌 숫자가 되도록, 순서형 정수로 인코딩한다.


```python
oe = OrdinalEncoder()
df_X[categorical_names] = oe.fit_transform(df_X[categorical_names])
df_X.head()
```





  <div id="df-c571ba5a-6c67-4d4a-9eb9-c6ba973ffdf4" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>30</td>
      <td>1787</td>
      <td>79</td>
      <td>1</td>
      <td>-1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>7.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>33</td>
      <td>4789</td>
      <td>220</td>
      <td>1</td>
      <td>339</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>35</td>
      <td>1350</td>
      <td>185</td>
      <td>1</td>
      <td>330</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4.0</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>6.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>30</td>
      <td>1476</td>
      <td>199</td>
      <td>4</td>
      <td>-1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>8.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>59</td>
      <td>0</td>
      <td>226</td>
      <td>1</td>
      <td>-1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-c571ba5a-6c67-4d4a-9eb9-c6ba973ffdf4')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-c571ba5a-6c67-4d4a-9eb9-c6ba973ffdf4 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-c571ba5a-6c67-4d4a-9eb9-c6ba973ffdf4');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-168468b1-a53f-43cb-aeb6-8a464e085e35">
  <button class="colab-df-quickchart" onclick="quickchart('df-168468b1-a53f-43cb-aeb6-8a464e085e35')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-168468b1-a53f-43cb-aeb6-8a464e085e35 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>




### 2.5 학습데이터와 시험데이터 분할
목적변수 역시 0과 1로 맵핑한다. 데이터를 alibi로 다루어야 하므로 alibi 라이브러리가 취급하는 numpy로 형변환 후 학습데이터와 시험데이터로 분할한다. 


```python
df_target = df_target["y"].map({'no': 0,'yes': 1})
X, y = df_X.to_numpy(), df_target.to_numpy()
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

print(X_train[:3])
print(y[:3])
```

    [[   2.    0.    2.    0.    0.    0.    0.    9.    3.    2.   34.  262.
       371.    1.   -1.    0.]
     [   4.    1.    2.    0.    0.    0.    0.    1.    3.    2.   32. 2349.
       134.    5.   -1.    0.]
     [   9.    2.    1.    0.    0.    0.    0.    1.    3.    0.   34. 1076.
        70.    2.   -1.    0.]]
    [0 0 0]


### 2.6 Column Transformer 적용
실수형 변수의 표준화와 범주형 변수의 one-hot 인코딩을 한번에 처리하기 위해 ColumnTransformer를 사용한다. X 데이터를 Column Transformer에 통과시켜(transform) X_train_ohe를 생성한다. 이는 분류모형을 적합시킬 때 사용될 것이다. 


```python
preprocessor = ColumnTransformer(
    transformers=[
        ('num', StandardScaler(), numerical_ids),
        ('cat', OneHotEncoder(handle_unknown='ignore', sparse_output=False), categorical_ids)
    ])
```


```python
preprocessor.fit(X_train)

X_train_ohe = preprocessor.transform(X_train)
X_test_ohe = preprocessor.transform(X_test)
```

## 3. 블랙박스 분류모형 생성
CounterfactualRL은 미분가능한 glass box 모형은 물론 미분불가능한 블랙박스 모형에도 적용할 수 있다. 이 과제에서는 미분이 불가능한 블랙박스 모형인 Random Forest 모형으로 이항분류문제를 학습시키기로 한다. 


```python
clf = RandomForestClassifier(max_depth=5, min_samples_split=10, random_state=42)
clf.fit(X_train_ohe, y_train) # ravel(): flattens y_train... from shape (3616,1) to shape (3616,)
```




<style>#sk-container-id-2 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-2 {
  color: var(--sklearn-color-text);
}

#sk-container-id-2 pre {
  padding: 0;
}

#sk-container-id-2 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-2 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-2 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-2 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-2 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-2 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-2 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-2 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-2 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-2 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-2 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-2 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-2 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-2 div.sk-label label.sk-toggleable__label,
#sk-container-id-2 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-2 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-2 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-2 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-2 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-2 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-2 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-2 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-2 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-2 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>RandomForestClassifier(max_depth=5, min_samples_split=10, random_state=42)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox" checked><label for="sk-estimator-id-2" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;RandomForestClassifier<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.ensemble.RandomForestClassifier.html">?<span>Documentation for RandomForestClassifier</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>RandomForestClassifier(max_depth=5, min_samples_split=10, random_state=42)</pre></div> </div></div></div></div>



분류모형이 블랙박스이므로 CFRL 동기화 시 모형 대신 예측함수를 파라미터로 넘겨주어야 한다. 다음과 같이 예측함수를 미리 정의해 둔다. 


```python
# 블랙박스 모형이므로 예측함수를 정의해서 나중에 인자로 넘겨준다
predictor = lambda x: clf.predict_proba(preprocessor.transform(x))

# 모형의 accuracy를 구하면 이렇다.
acc = accuracy_score(y_true=y_test, y_pred=predictor(X_test).argmax(axis=1))
print(f'Accuracy: {acc}')
f1 = f1_score(y_true=y_test, y_pred=predictor(X_test).argmax(axis=1))
print(f'F1 score: {f1}')
```

    Accuracy: 0.8983425414364641
    F1 score: 0.1320754716981132


## AutoEncoder 정의
### 4.1 encoder
Encoder 클래스는 keras 모듈의 Model 클래스를 상속받는다. __init__은 생성자(Constructor)를 정의하는데, 인자로 hidden_dim과 latent_dim이 주어지면 그 숫자를 각각 노드 수로 하는 Fully connected(Dense) 층을 만든다. 한편 call을 정의하면 Encoder 클래스의 인스턴스는 함수처럼 호출될 수 있으며, 인자로 들어가는 x는 fc1층과 relu 활성함수, fc2층과 tanh 활성함수를 차례로 통과하게 된다. 


```python
class Encoder(keras.Model):
  # Constructor
  def __init__(self, hidden_dim, latent_dim, **kwargs):
    super().__init__(**kwargs)
    self.fc1 = keras.layers.Dense(hidden_dim)
    self.fc2 = keras.layers.Dense(latent_dim)

  # callable . call을 정의하면 이 클래스의 인스턴스는 함수처럼 호출될 수 있다.
  def call(self, x:tf.Tensor, **kwargs) -> tf.Tensor:
    x = self.fc1(x)
    x = tf.nn.relu(x)
    x = self.fc2(x)
    x = tf.nn.tanh(x)
    return x
```

### 4.2 decoder
Decoder 클래스 역시 keras Model 클래스의 자식 클래스이다. CFRL에서 사용되는 decoder의 특징은 다중 출력층(Multiple outputs)이다. 첫번째 출력층은 실수형 특성변수를 출력한다(총 6개 노드). 두번째 이후 출력층은 범주형 특성변수의 출력이다. 각 출력층에는 범주형 특성변수의 범주 수만큼 노드가 있다. 


```python
class Decoder(keras.Model):
  def __init__(self, hidden_dim, output_dims, **kwargs):
    super().__init__(**kwargs)
    self.fc1 = keras.layers.Dense(hidden_dim)
    self.fcs = [keras.layers.Dense(dim) for dim in output_dims]
  def call(self, x:tf.Tensor, **kwargs) -> tf.Tensor:
    x = self.fc1(x)
    x = tf.nn.relu(x)
    xs = [fc(x) for fc in self.fcs]
    return xs

```

### 4.3 Encoder와 Decoder 연결: HeAutoEncoder
HeAutoEncoder 클래스는 encoder와 decoder를 입력받으면서 동기화 된다. encoder의 출력(z)이 decoder의 입력으로 들어감을 확인할 수 있다. 



```python
class HeAutoEncoder(keras.Model):
  def __init__(self, encoder:keras.Model, decoder:keras.Model, **kwargs):
    super().__init__(**kwargs)
    self.encoder = encoder
    self.decoder = decoder
  def call(self, x: tf.Tensor, **kwargs):
    z = self.encoder(x)
    x_hat = self.decoder(z)
    return x_hat
```

## 4.4 auto encoder의 입력데이터와 출력데이터 정의

get_he_preprocessor() 함수는 `data preprocessor`와 `inverse data preprocessor`를 반환한다.

- `data preprocessor` (heae_preprocessor)

Tabular 데이터에는 실수형과 범주형이라는, 이질적인(heterogeneous) 데이터 타입이 혼재되어 있다.
alibi 라이브러리의 get_he_preprocessor() 함수는 실수형 특성변수는 표준화 하고 범주형 특성변수는 one-hot 인코딩 함으로써 counterfactual 생성 시 모든 변수가 일관적으로 다뤄질 수 있도록 한다.

- `inverse data preprocessor` (heae_inv_preprocessor)

강화학습 모형에서 encoder출력 형태로 출력되는 특성변수를 원래의 특성변수 형식으로 환원한다. `inv_preprocessor(preprocessor(x)) = x`
생성된 counterfactual은 모형이 학습한 입력데이터 형태와 동일한 형태로 출력되어야 한다. counterfactual이 모형이 이해할 수 있는 형태로 출력되어야 해석이 가능하기 때문이다.

### 4.4 HeAutoEncoder의 입력데이터와 출력데이터 정의
alibi 라이브러리가 제공하는 get_he_preprocessor() 함수는 data preprocessor와 inverse data preprocessor를 반환한다. 여기서 he는 heterogeneous(이질적인)를 의미한다. Tabular 데이터에는 실수형과 범주형이라는, 이질적인 데이터 타입이 혼재되어 있다. 
- get_he_preprocessor()의 반환 중 data processor는 실수형 특성변수를 표준화 하고 범주형 특성변수는 one-hot 인코딩 함으로써 counterfactual 생성 시 모든 변수가 일관적으로 다뤄질 수 있도록 한다. 
- 한편 inverse data preprocessor는 강화학습 모형에서 encoder출력 형태로 출력되는 특성변수를 원래의 특성변수 형식으로 환원한다. 즉 heae_inv_preprocessor(heae_preprocessor(x)) = x이다. counterfactual은 모형이 이해할 수 있는 형태로 출력되어야(즉, 모형이 학습한 입력데이터 형태와 동일한 형태로 출력되어야) 해석이 가능하다. 이를 가능케 하는 것이 inverse data preprocessor이다. 



```python
# Define attribute types, required for datatype conversion.
feature_types = {"Age": int, "Balance": int, "Duration": int, "Campaign": int, "PDays": int, "Previous": int}

heae_preprocessor, heae_inv_preprocessor = get_he_preprocessor(X=X_train,
                                                               feature_names=feature_names,
                                                               category_map = category_map,
                                                               feature_types=feature_types)
```

한편 HeAutoEncoder에도 fit 단계가 필요하며 학습데이터 X, y를 fit 메서드에 넘겨야 한다. 이때 fit의 X 인자에는 기 생성한 X_train을 heae_preprocessor에 통과시켜 전처리한 trainset_input을 넘겨준다. 한편 fit의 y 인자에는 HeAutoEncoder의 출력이 다중 출력이므로 dictionary 타입의 trainset_output을 넘겨준다. 실수형 특성변수에 해당하는 key는 “output_1”이고 범주형 특성변수에 해당하는 key는 “output_2”부터 “output_11”이다. 

trainset_input과 trainset_output을 튜플로 묶은 후 from_tensor_slices를 적용하면 첫번째 축으로 잘라서 trainset_input과 trainset_output을 짝지어 가져온다. 잘 섞은 후(shuffle) 32배치 단위로 표본을 추출한다. 


```python
# Define trainset
# input
trainset_input = heae_preprocessor(X_train).astype(np.float32)
print(trainset_input.shape)

# output
trainset_output = {"output_1": trainset_input[:, :len(numerical_ids)]} #initialize with numeric variables in 1st output layer
for i, cat_id in enumerate(categorical_ids):
  trainset_output.update({f"output_{i+2}": X_train[:, cat_id]})

# trainset
trainset = tf.data.Dataset.from_tensor_slices((trainset_input, trainset_output))  # tuple
trainset = trainset.shuffle(128).batch(32, drop_remainder=True)
```

    (3616, 53)


다음으로 파라미터 값을 지정한다.
- `HIDDEN_DIM`: encoder와 decoder의 은닉층 수를 뜻한다.
- `LATENT_DIM`: encoder의 출력노드 수
- `OUTPUT_DIMS`: 다중출력인 decoder의 각 출력층의 출력노드 수  
    - `OUTPUT_DIMS`를 출력하여 확인하면 실수형 특성변수의 출력노드 수는 6개, 첫번째 특성변수(job)의 범주값이 12개이므로 출력노드 또한 12개, ...임을 알 수 있다. 


```python
EPOCHS = 50
HIDDEN_DIM = 64
LATENT_DIM = 15

OUTPUT_DIMS = [len(numerical_ids)]
OUTPUT_DIMS += [len(category_map[i]) for i in categorical_ids]

print(OUTPUT_DIMS)
```

    [6, 12, 3, 4, 2, 2, 2, 3, 12, 4, 3]


### 4.5 HeAutoEncoder 학습
HeAutoEncoder의 학습을 위해 손실함수와 가중치를 정의한다. 실수형 목적변수의 손실함수는 MSE를, 범주형 목적변수의 손실함수는 SparseCategoricalCrossentropy를 부여한다. 범주형 목적변수가 순서형 정수로 맵핑되었기 때문이다. SparseCategoricalCrossentropy 손실의 경우, HeAutoEncoder 모형의 마지막 레이어에서 소프트맥스를 사용하지 않았기 때문에 from_logits=True로 하여 모델의 마지막 출력인 logit값을 가지고 손실함수가 내부적으로 소프트맥스를 처리하도록 한다. 손실함수의 가중치는 실수형은 1, 범주형에는 각각 1/10(10은 범주형 특성변수의 개수이다)을 준다. 

(참고)
- from_logits=True를 사용할 경우, 모델의 마지막 레이어에서 소프트맥스를 직접 적용하지 않아야 한다. 모델의 마지막 출력이 로짓이어야 하며, 소프트맥스를 내부적으로 손실 함수에서 처리한다.
- from_logits=False를 사용할 경우, 모델의 마지막 레이어에서 소프트맥스를 직접 적용하여 출력값을 확률로 변환한 상태여야 한다.


```python
# HE 오토인코더 생성
heae = HeAutoEncoder(encoder = Encoder(hidden_dim = HIDDEN_DIM, latent_dim = LATENT_DIM),
                     decoder = Decoder(hidden_dim = HIDDEN_DIM, output_dims = OUTPUT_DIMS)
                     )

# 손실함수와 가중치: 일단 실수형 목적변수의 손실함수와 가중치로 초기화
he_loss = [keras.losses.MeanSquaredError()]
he_loss_weights = [1.]

# 범주형 목적변수의 손실함수 및 가중치를 붙인다(append)
for i in range(len(categorical_ids)):
  he_loss.append(keras.losses.SparseCategoricalCrossentropy(from_logits=True))
  he_loss_weights.append(1./len(categorical_ids))

# metrics
metrics = {}
for i, cat_name in enumerate(categorical_names):
  metrics.update({f"output_{i+2}": keras.metrics.SparseCategoricalAccuracy()})

# complie and fit
heae.compile(optimizer = keras.optimizers.Adam(learning_rate=0.001),
             loss = he_loss,
             loss_weights = he_loss_weights,
             metrics = metrics)
heae.fit(trainset, epochs = EPOCHS)
```

    Epoch 1/50
    113/113 [==============================] - 4s 3ms/step - loss: 1.5737 - output_1_loss: 0.5448 - output_2_loss: 2.1832 - output_3_loss: 0.8757 - output_4_loss: 1.1217 - output_5_loss: 0.2658 - output_6_loss: 0.5912 - output_7_loss: 0.4413 - output_8_loss: 0.8606 - output_9_loss: 2.1493 - output_10_loss: 0.7867 - output_11_loss: 1.0138 - output_2_sparse_categorical_accuracy: 0.2154 - output_3_sparse_categorical_accuracy: 0.5835 - output_4_sparse_categorical_accuracy: 0.5094 - output_5_sparse_categorical_accuracy: 0.9187 - output_6_sparse_categorical_accuracy: 0.7171 - output_7_sparse_categorical_accuracy: 0.8382 - output_8_sparse_categorical_accuracy: 0.6347 - output_9_sparse_categorical_accuracy: 0.2652 - output_10_sparse_categorical_accuracy: 0.7367 - output_11_sparse_categorical_accuracy: 0.4726
    Epoch 2/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.9347 - output_1_loss: 0.1572 - output_2_loss: 1.9357 - output_3_loss: 0.6688 - output_4_loss: 0.9531 - output_5_loss: 0.0739 - output_6_loss: 0.3693 - output_7_loss: 0.3317 - output_8_loss: 0.5637 - output_9_loss: 1.7072 - output_10_loss: 0.3214 - output_11_loss: 0.8502 - output_2_sparse_categorical_accuracy: 0.3349 - output_3_sparse_categorical_accuracy: 0.7550 - output_4_sparse_categorical_accuracy: 0.5946 - output_5_sparse_categorical_accuracy: 0.9848 - output_6_sparse_categorical_accuracy: 0.8556 - output_7_sparse_categorical_accuracy: 0.8545 - output_8_sparse_categorical_accuracy: 0.8225 - output_9_sparse_categorical_accuracy: 0.4386 - output_10_sparse_categorical_accuracy: 0.8908 - output_11_sparse_categorical_accuracy: 0.6361
    Epoch 3/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.7360 - output_1_loss: 0.1036 - output_2_loss: 1.7574 - output_3_loss: 0.5459 - output_4_loss: 0.7809 - output_5_loss: 0.0693 - output_6_loss: 0.2327 - output_7_loss: 0.2710 - output_8_loss: 0.3860 - output_9_loss: 1.4351 - output_10_loss: 0.2574 - output_11_loss: 0.5883 - output_2_sparse_categorical_accuracy: 0.4145 - output_3_sparse_categorical_accuracy: 0.7918 - output_4_sparse_categorical_accuracy: 0.6963 - output_5_sparse_categorical_accuracy: 0.9848 - output_6_sparse_categorical_accuracy: 0.9168 - output_7_sparse_categorical_accuracy: 0.8924 - output_8_sparse_categorical_accuracy: 0.8963 - output_9_sparse_categorical_accuracy: 0.5570 - output_10_sparse_categorical_accuracy: 0.9098 - output_11_sparse_categorical_accuracy: 0.8233
    Epoch 4/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.5936 - output_1_loss: 0.0856 - output_2_loss: 1.5404 - output_3_loss: 0.4472 - output_4_loss: 0.5189 - output_5_loss: 0.0665 - output_6_loss: 0.1578 - output_7_loss: 0.2523 - output_8_loss: 0.3019 - output_9_loss: 1.2047 - output_10_loss: 0.2291 - output_11_loss: 0.3602 - output_2_sparse_categorical_accuracy: 0.5069 - output_3_sparse_categorical_accuracy: 0.8410 - output_4_sparse_categorical_accuracy: 0.8479 - output_5_sparse_categorical_accuracy: 0.9848 - output_6_sparse_categorical_accuracy: 0.9591 - output_7_sparse_categorical_accuracy: 0.9118 - output_8_sparse_categorical_accuracy: 0.9173 - output_9_sparse_categorical_accuracy: 0.6184 - output_10_sparse_categorical_accuracy: 0.9118 - output_11_sparse_categorical_accuracy: 0.9226
    Epoch 5/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.4955 - output_1_loss: 0.0731 - output_2_loss: 1.3558 - output_3_loss: 0.3574 - output_4_loss: 0.3618 - output_5_loss: 0.0638 - output_6_loss: 0.1266 - output_7_loss: 0.2299 - output_8_loss: 0.2639 - output_9_loss: 1.0158 - output_10_loss: 0.2075 - output_11_loss: 0.2420 - output_2_sparse_categorical_accuracy: 0.5592 - output_3_sparse_categorical_accuracy: 0.8852 - output_4_sparse_categorical_accuracy: 0.9115 - output_5_sparse_categorical_accuracy: 0.9848 - output_6_sparse_categorical_accuracy: 0.9723 - output_7_sparse_categorical_accuracy: 0.9220 - output_8_sparse_categorical_accuracy: 0.9242 - output_9_sparse_categorical_accuracy: 0.6828 - output_10_sparse_categorical_accuracy: 0.9192 - output_11_sparse_categorical_accuracy: 0.9563
    Epoch 6/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.4309 - output_1_loss: 0.0627 - output_2_loss: 1.2016 - output_3_loss: 0.2894 - output_4_loss: 0.3091 - output_5_loss: 0.0601 - output_6_loss: 0.1117 - output_7_loss: 0.1993 - output_8_loss: 0.2397 - output_9_loss: 0.8846 - output_10_loss: 0.1926 - output_11_loss: 0.1947 - output_2_sparse_categorical_accuracy: 0.6137 - output_3_sparse_categorical_accuracy: 0.9137 - output_4_sparse_categorical_accuracy: 0.9154 - output_5_sparse_categorical_accuracy: 0.9848 - output_6_sparse_categorical_accuracy: 0.9726 - output_7_sparse_categorical_accuracy: 0.9345 - output_8_sparse_categorical_accuracy: 0.9256 - output_9_sparse_categorical_accuracy: 0.7293 - output_10_sparse_categorical_accuracy: 0.9223 - output_11_sparse_categorical_accuracy: 0.9618
    Epoch 7/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.3848 - output_1_loss: 0.0554 - output_2_loss: 1.0764 - output_3_loss: 0.2481 - output_4_loss: 0.2859 - output_5_loss: 0.0556 - output_6_loss: 0.1016 - output_7_loss: 0.1641 - output_8_loss: 0.2199 - output_9_loss: 0.7907 - output_10_loss: 0.1813 - output_11_loss: 0.1697 - output_2_sparse_categorical_accuracy: 0.6568 - output_3_sparse_categorical_accuracy: 0.9278 - output_4_sparse_categorical_accuracy: 0.9137 - output_5_sparse_categorical_accuracy: 0.9851 - output_6_sparse_categorical_accuracy: 0.9737 - output_7_sparse_categorical_accuracy: 0.9466 - output_8_sparse_categorical_accuracy: 0.9303 - output_9_sparse_categorical_accuracy: 0.7622 - output_10_sparse_categorical_accuracy: 0.9256 - output_11_sparse_categorical_accuracy: 0.9649
    Epoch 8/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.3466 - output_1_loss: 0.0485 - output_2_loss: 0.9792 - output_3_loss: 0.2216 - output_4_loss: 0.2634 - output_5_loss: 0.0494 - output_6_loss: 0.0932 - output_7_loss: 0.1292 - output_8_loss: 0.2027 - output_9_loss: 0.7198 - output_10_loss: 0.1713 - output_11_loss: 0.1512 - output_2_sparse_categorical_accuracy: 0.6858 - output_3_sparse_categorical_accuracy: 0.9372 - output_4_sparse_categorical_accuracy: 0.9162 - output_5_sparse_categorical_accuracy: 0.9851 - output_6_sparse_categorical_accuracy: 0.9740 - output_7_sparse_categorical_accuracy: 0.9613 - output_8_sparse_categorical_accuracy: 0.9339 - output_9_sparse_categorical_accuracy: 0.7854 - output_10_sparse_categorical_accuracy: 0.9311 - output_11_sparse_categorical_accuracy: 0.9676
    Epoch 9/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.3166 - output_1_loss: 0.0446 - output_2_loss: 0.8969 - output_3_loss: 0.2012 - output_4_loss: 0.2451 - output_5_loss: 0.0437 - output_6_loss: 0.0854 - output_7_loss: 0.0994 - output_8_loss: 0.1884 - output_9_loss: 0.6652 - output_10_loss: 0.1628 - output_11_loss: 0.1322 - output_2_sparse_categorical_accuracy: 0.7107 - output_3_sparse_categorical_accuracy: 0.9416 - output_4_sparse_categorical_accuracy: 0.9184 - output_5_sparse_categorical_accuracy: 0.9856 - output_6_sparse_categorical_accuracy: 0.9743 - output_7_sparse_categorical_accuracy: 0.9715 - output_8_sparse_categorical_accuracy: 0.9389 - output_9_sparse_categorical_accuracy: 0.8020 - output_10_sparse_categorical_accuracy: 0.9378 - output_11_sparse_categorical_accuracy: 0.9712
    Epoch 10/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.2911 - output_1_loss: 0.0406 - output_2_loss: 0.8309 - output_3_loss: 0.1831 - output_4_loss: 0.2334 - output_5_loss: 0.0386 - output_6_loss: 0.0782 - output_7_loss: 0.0769 - output_8_loss: 0.1738 - output_9_loss: 0.6164 - output_10_loss: 0.1553 - output_11_loss: 0.1189 - output_2_sparse_categorical_accuracy: 0.7306 - output_3_sparse_categorical_accuracy: 0.9450 - output_4_sparse_categorical_accuracy: 0.9215 - output_5_sparse_categorical_accuracy: 0.9859 - output_6_sparse_categorical_accuracy: 0.9751 - output_7_sparse_categorical_accuracy: 0.9812 - output_8_sparse_categorical_accuracy: 0.9422 - output_9_sparse_categorical_accuracy: 0.8216 - output_10_sparse_categorical_accuracy: 0.9372 - output_11_sparse_categorical_accuracy: 0.9732
    Epoch 11/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.2713 - output_1_loss: 0.0380 - output_2_loss: 0.7741 - output_3_loss: 0.1721 - output_4_loss: 0.2221 - output_5_loss: 0.0339 - output_6_loss: 0.0723 - output_7_loss: 0.0636 - output_8_loss: 0.1623 - output_9_loss: 0.5756 - output_10_loss: 0.1484 - output_11_loss: 0.1084 - output_2_sparse_categorical_accuracy: 0.7503 - output_3_sparse_categorical_accuracy: 0.9488 - output_4_sparse_categorical_accuracy: 0.9262 - output_5_sparse_categorical_accuracy: 0.9862 - output_6_sparse_categorical_accuracy: 0.9759 - output_7_sparse_categorical_accuracy: 0.9853 - output_8_sparse_categorical_accuracy: 0.9483 - output_9_sparse_categorical_accuracy: 0.8363 - output_10_sparse_categorical_accuracy: 0.9405 - output_11_sparse_categorical_accuracy: 0.9754
    Epoch 12/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.2542 - output_1_loss: 0.0352 - output_2_loss: 0.7262 - output_3_loss: 0.1612 - output_4_loss: 0.2131 - output_5_loss: 0.0305 - output_6_loss: 0.0674 - output_7_loss: 0.0551 - output_8_loss: 0.1520 - output_9_loss: 0.5400 - output_10_loss: 0.1432 - output_11_loss: 0.1017 - output_2_sparse_categorical_accuracy: 0.7680 - output_3_sparse_categorical_accuracy: 0.9499 - output_4_sparse_categorical_accuracy: 0.9289 - output_5_sparse_categorical_accuracy: 0.9870 - output_6_sparse_categorical_accuracy: 0.9790 - output_7_sparse_categorical_accuracy: 0.9876 - output_8_sparse_categorical_accuracy: 0.9505 - output_9_sparse_categorical_accuracy: 0.8501 - output_10_sparse_categorical_accuracy: 0.9425 - output_11_sparse_categorical_accuracy: 0.9768
    Epoch 13/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.2409 - output_1_loss: 0.0335 - output_2_loss: 0.6863 - output_3_loss: 0.1547 - output_4_loss: 0.2051 - output_5_loss: 0.0269 - output_6_loss: 0.0643 - output_7_loss: 0.0507 - output_8_loss: 0.1425 - output_9_loss: 0.5057 - output_10_loss: 0.1392 - output_11_loss: 0.0980 - output_2_sparse_categorical_accuracy: 0.7785 - output_3_sparse_categorical_accuracy: 0.9502 - output_4_sparse_categorical_accuracy: 0.9306 - output_5_sparse_categorical_accuracy: 0.9887 - output_6_sparse_categorical_accuracy: 0.9806 - output_7_sparse_categorical_accuracy: 0.9878 - output_8_sparse_categorical_accuracy: 0.9541 - output_9_sparse_categorical_accuracy: 0.8590 - output_10_sparse_categorical_accuracy: 0.9436 - output_11_sparse_categorical_accuracy: 0.9743
    Epoch 14/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.2295 - output_1_loss: 0.0325 - output_2_loss: 0.6532 - output_3_loss: 0.1483 - output_4_loss: 0.1971 - output_5_loss: 0.0246 - output_6_loss: 0.0597 - output_7_loss: 0.0472 - output_8_loss: 0.1353 - output_9_loss: 0.4764 - output_10_loss: 0.1357 - output_11_loss: 0.0926 - output_2_sparse_categorical_accuracy: 0.7962 - output_3_sparse_categorical_accuracy: 0.9533 - output_4_sparse_categorical_accuracy: 0.9364 - output_5_sparse_categorical_accuracy: 0.9900 - output_6_sparse_categorical_accuracy: 0.9812 - output_7_sparse_categorical_accuracy: 0.9873 - output_8_sparse_categorical_accuracy: 0.9555 - output_9_sparse_categorical_accuracy: 0.8703 - output_10_sparse_categorical_accuracy: 0.9428 - output_11_sparse_categorical_accuracy: 0.9768
    Epoch 15/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.2179 - output_1_loss: 0.0296 - output_2_loss: 0.6246 - output_3_loss: 0.1438 - output_4_loss: 0.1896 - output_5_loss: 0.0221 - output_6_loss: 0.0564 - output_7_loss: 0.0451 - output_8_loss: 0.1287 - output_9_loss: 0.4504 - output_10_loss: 0.1323 - output_11_loss: 0.0895 - output_2_sparse_categorical_accuracy: 0.8012 - output_3_sparse_categorical_accuracy: 0.9527 - output_4_sparse_categorical_accuracy: 0.9367 - output_5_sparse_categorical_accuracy: 0.9914 - output_6_sparse_categorical_accuracy: 0.9812 - output_7_sparse_categorical_accuracy: 0.9878 - output_8_sparse_categorical_accuracy: 0.9580 - output_9_sparse_categorical_accuracy: 0.8769 - output_10_sparse_categorical_accuracy: 0.9455 - output_11_sparse_categorical_accuracy: 0.9765
    Epoch 16/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.2080 - output_1_loss: 0.0281 - output_2_loss: 0.5956 - output_3_loss: 0.1378 - output_4_loss: 0.1836 - output_5_loss: 0.0204 - output_6_loss: 0.0531 - output_7_loss: 0.0434 - output_8_loss: 0.1232 - output_9_loss: 0.4273 - output_10_loss: 0.1297 - output_11_loss: 0.0858 - output_2_sparse_categorical_accuracy: 0.8161 - output_3_sparse_categorical_accuracy: 0.9533 - output_4_sparse_categorical_accuracy: 0.9383 - output_5_sparse_categorical_accuracy: 0.9920 - output_6_sparse_categorical_accuracy: 0.9834 - output_7_sparse_categorical_accuracy: 0.9892 - output_8_sparse_categorical_accuracy: 0.9610 - output_9_sparse_categorical_accuracy: 0.8827 - output_10_sparse_categorical_accuracy: 0.9497 - output_11_sparse_categorical_accuracy: 0.9793
    Epoch 17/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.2000 - output_1_loss: 0.0268 - output_2_loss: 0.5715 - output_3_loss: 0.1344 - output_4_loss: 0.1766 - output_5_loss: 0.0185 - output_6_loss: 0.0514 - output_7_loss: 0.0424 - output_8_loss: 0.1175 - output_9_loss: 0.4075 - output_10_loss: 0.1280 - output_11_loss: 0.0834 - output_2_sparse_categorical_accuracy: 0.8252 - output_3_sparse_categorical_accuracy: 0.9560 - output_4_sparse_categorical_accuracy: 0.9405 - output_5_sparse_categorical_accuracy: 0.9934 - output_6_sparse_categorical_accuracy: 0.9848 - output_7_sparse_categorical_accuracy: 0.9892 - output_8_sparse_categorical_accuracy: 0.9613 - output_9_sparse_categorical_accuracy: 0.8888 - output_10_sparse_categorical_accuracy: 0.9491 - output_11_sparse_categorical_accuracy: 0.9795
    Epoch 18/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1924 - output_1_loss: 0.0264 - output_2_loss: 0.5459 - output_3_loss: 0.1298 - output_4_loss: 0.1710 - output_5_loss: 0.0167 - output_6_loss: 0.0477 - output_7_loss: 0.0415 - output_8_loss: 0.1122 - output_9_loss: 0.3896 - output_10_loss: 0.1242 - output_11_loss: 0.0817 - output_2_sparse_categorical_accuracy: 0.8438 - output_3_sparse_categorical_accuracy: 0.9593 - output_4_sparse_categorical_accuracy: 0.9436 - output_5_sparse_categorical_accuracy: 0.9939 - output_6_sparse_categorical_accuracy: 0.9862 - output_7_sparse_categorical_accuracy: 0.9898 - output_8_sparse_categorical_accuracy: 0.9652 - output_9_sparse_categorical_accuracy: 0.8935 - output_10_sparse_categorical_accuracy: 0.9497 - output_11_sparse_categorical_accuracy: 0.9804
    Epoch 19/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1851 - output_1_loss: 0.0252 - output_2_loss: 0.5195 - output_3_loss: 0.1265 - output_4_loss: 0.1669 - output_5_loss: 0.0156 - output_6_loss: 0.0462 - output_7_loss: 0.0405 - output_8_loss: 0.1083 - output_9_loss: 0.3738 - output_10_loss: 0.1225 - output_11_loss: 0.0791 - output_2_sparse_categorical_accuracy: 0.8603 - output_3_sparse_categorical_accuracy: 0.9599 - output_4_sparse_categorical_accuracy: 0.9441 - output_5_sparse_categorical_accuracy: 0.9947 - output_6_sparse_categorical_accuracy: 0.9876 - output_7_sparse_categorical_accuracy: 0.9895 - output_8_sparse_categorical_accuracy: 0.9674 - output_9_sparse_categorical_accuracy: 0.8974 - output_10_sparse_categorical_accuracy: 0.9511 - output_11_sparse_categorical_accuracy: 0.9790
    Epoch 20/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1791 - output_1_loss: 0.0250 - output_2_loss: 0.4975 - output_3_loss: 0.1232 - output_4_loss: 0.1638 - output_5_loss: 0.0144 - output_6_loss: 0.0439 - output_7_loss: 0.0395 - output_8_loss: 0.1039 - output_9_loss: 0.3591 - output_10_loss: 0.1193 - output_11_loss: 0.0762 - output_2_sparse_categorical_accuracy: 0.8706 - output_3_sparse_categorical_accuracy: 0.9624 - output_4_sparse_categorical_accuracy: 0.9458 - output_5_sparse_categorical_accuracy: 0.9945 - output_6_sparse_categorical_accuracy: 0.9884 - output_7_sparse_categorical_accuracy: 0.9900 - output_8_sparse_categorical_accuracy: 0.9696 - output_9_sparse_categorical_accuracy: 0.8996 - output_10_sparse_categorical_accuracy: 0.9513 - output_11_sparse_categorical_accuracy: 0.9798
    Epoch 21/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1728 - output_1_loss: 0.0241 - output_2_loss: 0.4723 - output_3_loss: 0.1185 - output_4_loss: 0.1607 - output_5_loss: 0.0136 - output_6_loss: 0.0419 - output_7_loss: 0.0384 - output_8_loss: 0.1002 - output_9_loss: 0.3482 - output_10_loss: 0.1170 - output_11_loss: 0.0754 - output_2_sparse_categorical_accuracy: 0.8811 - output_3_sparse_categorical_accuracy: 0.9640 - output_4_sparse_categorical_accuracy: 0.9480 - output_5_sparse_categorical_accuracy: 0.9945 - output_6_sparse_categorical_accuracy: 0.9881 - output_7_sparse_categorical_accuracy: 0.9892 - output_8_sparse_categorical_accuracy: 0.9688 - output_9_sparse_categorical_accuracy: 0.9024 - output_10_sparse_categorical_accuracy: 0.9511 - output_11_sparse_categorical_accuracy: 0.9812
    Epoch 22/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1666 - output_1_loss: 0.0233 - output_2_loss: 0.4501 - output_3_loss: 0.1149 - output_4_loss: 0.1578 - output_5_loss: 0.0126 - output_6_loss: 0.0405 - output_7_loss: 0.0379 - output_8_loss: 0.0967 - output_9_loss: 0.3354 - output_10_loss: 0.1141 - output_11_loss: 0.0733 - output_2_sparse_categorical_accuracy: 0.8861 - output_3_sparse_categorical_accuracy: 0.9657 - output_4_sparse_categorical_accuracy: 0.9488 - output_5_sparse_categorical_accuracy: 0.9956 - output_6_sparse_categorical_accuracy: 0.9884 - output_7_sparse_categorical_accuracy: 0.9895 - output_8_sparse_categorical_accuracy: 0.9693 - output_9_sparse_categorical_accuracy: 0.9057 - output_10_sparse_categorical_accuracy: 0.9546 - output_11_sparse_categorical_accuracy: 0.9806
    Epoch 23/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1615 - output_1_loss: 0.0228 - output_2_loss: 0.4327 - output_3_loss: 0.1085 - output_4_loss: 0.1552 - output_5_loss: 0.0124 - output_6_loss: 0.0394 - output_7_loss: 0.0365 - output_8_loss: 0.0930 - output_9_loss: 0.3252 - output_10_loss: 0.1122 - output_11_loss: 0.0719 - output_2_sparse_categorical_accuracy: 0.8891 - output_3_sparse_categorical_accuracy: 0.9693 - output_4_sparse_categorical_accuracy: 0.9541 - output_5_sparse_categorical_accuracy: 0.9959 - output_6_sparse_categorical_accuracy: 0.9884 - output_7_sparse_categorical_accuracy: 0.9898 - output_8_sparse_categorical_accuracy: 0.9710 - output_9_sparse_categorical_accuracy: 0.9118 - output_10_sparse_categorical_accuracy: 0.9535 - output_11_sparse_categorical_accuracy: 0.9812
    Epoch 24/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1569 - output_1_loss: 0.0226 - output_2_loss: 0.4158 - output_3_loss: 0.1052 - output_4_loss: 0.1531 - output_5_loss: 0.0116 - output_6_loss: 0.0369 - output_7_loss: 0.0352 - output_8_loss: 0.0897 - output_9_loss: 0.3149 - output_10_loss: 0.1101 - output_11_loss: 0.0701 - output_2_sparse_categorical_accuracy: 0.8924 - output_3_sparse_categorical_accuracy: 0.9715 - output_4_sparse_categorical_accuracy: 0.9524 - output_5_sparse_categorical_accuracy: 0.9959 - output_6_sparse_categorical_accuracy: 0.9898 - output_7_sparse_categorical_accuracy: 0.9898 - output_8_sparse_categorical_accuracy: 0.9715 - output_9_sparse_categorical_accuracy: 0.9126 - output_10_sparse_categorical_accuracy: 0.9552 - output_11_sparse_categorical_accuracy: 0.9815
    Epoch 25/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1519 - output_1_loss: 0.0216 - output_2_loss: 0.3996 - output_3_loss: 0.1001 - output_4_loss: 0.1496 - output_5_loss: 0.0110 - output_6_loss: 0.0362 - output_7_loss: 0.0348 - output_8_loss: 0.0867 - output_9_loss: 0.3065 - output_10_loss: 0.1082 - output_11_loss: 0.0699 - output_2_sparse_categorical_accuracy: 0.8949 - output_3_sparse_categorical_accuracy: 0.9718 - output_4_sparse_categorical_accuracy: 0.9555 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9898 - output_7_sparse_categorical_accuracy: 0.9909 - output_8_sparse_categorical_accuracy: 0.9710 - output_9_sparse_categorical_accuracy: 0.9140 - output_10_sparse_categorical_accuracy: 0.9558 - output_11_sparse_categorical_accuracy: 0.9823
    Epoch 26/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1483 - output_1_loss: 0.0221 - output_2_loss: 0.3857 - output_3_loss: 0.0967 - output_4_loss: 0.1473 - output_5_loss: 0.0107 - output_6_loss: 0.0351 - output_7_loss: 0.0332 - output_8_loss: 0.0826 - output_9_loss: 0.2980 - output_10_loss: 0.1058 - output_11_loss: 0.0663 - output_2_sparse_categorical_accuracy: 0.8963 - output_3_sparse_categorical_accuracy: 0.9726 - output_4_sparse_categorical_accuracy: 0.9552 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9898 - output_7_sparse_categorical_accuracy: 0.9909 - output_8_sparse_categorical_accuracy: 0.9735 - output_9_sparse_categorical_accuracy: 0.9148 - output_10_sparse_categorical_accuracy: 0.9588 - output_11_sparse_categorical_accuracy: 0.9820
    Epoch 27/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1443 - output_1_loss: 0.0218 - output_2_loss: 0.3695 - output_3_loss: 0.0925 - output_4_loss: 0.1442 - output_5_loss: 0.0109 - output_6_loss: 0.0343 - output_7_loss: 0.0330 - output_8_loss: 0.0802 - output_9_loss: 0.2911 - output_10_loss: 0.1041 - output_11_loss: 0.0653 - output_2_sparse_categorical_accuracy: 0.9035 - output_3_sparse_categorical_accuracy: 0.9746 - output_4_sparse_categorical_accuracy: 0.9574 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9892 - output_7_sparse_categorical_accuracy: 0.9903 - output_8_sparse_categorical_accuracy: 0.9748 - output_9_sparse_categorical_accuracy: 0.9170 - output_10_sparse_categorical_accuracy: 0.9605 - output_11_sparse_categorical_accuracy: 0.9829
    Epoch 28/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1402 - output_1_loss: 0.0210 - output_2_loss: 0.3590 - output_3_loss: 0.0875 - output_4_loss: 0.1411 - output_5_loss: 0.0108 - output_6_loss: 0.0323 - output_7_loss: 0.0315 - output_8_loss: 0.0780 - output_9_loss: 0.2832 - output_10_loss: 0.1025 - output_11_loss: 0.0651 - output_2_sparse_categorical_accuracy: 0.9054 - output_3_sparse_categorical_accuracy: 0.9784 - output_4_sparse_categorical_accuracy: 0.9571 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9917 - output_7_sparse_categorical_accuracy: 0.9900 - output_8_sparse_categorical_accuracy: 0.9751 - output_9_sparse_categorical_accuracy: 0.9181 - output_10_sparse_categorical_accuracy: 0.9602 - output_11_sparse_categorical_accuracy: 0.9823
    Epoch 29/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1362 - output_1_loss: 0.0209 - output_2_loss: 0.3470 - output_3_loss: 0.0823 - output_4_loss: 0.1392 - output_5_loss: 0.0103 - output_6_loss: 0.0308 - output_7_loss: 0.0313 - output_8_loss: 0.0746 - output_9_loss: 0.2756 - output_10_loss: 0.0996 - output_11_loss: 0.0631 - output_2_sparse_categorical_accuracy: 0.9057 - output_3_sparse_categorical_accuracy: 0.9795 - output_4_sparse_categorical_accuracy: 0.9569 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9914 - output_7_sparse_categorical_accuracy: 0.9906 - output_8_sparse_categorical_accuracy: 0.9759 - output_9_sparse_categorical_accuracy: 0.9220 - output_10_sparse_categorical_accuracy: 0.9624 - output_11_sparse_categorical_accuracy: 0.9831
    Epoch 30/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1324 - output_1_loss: 0.0202 - output_2_loss: 0.3382 - output_3_loss: 0.0784 - output_4_loss: 0.1375 - output_5_loss: 0.0103 - output_6_loss: 0.0290 - output_7_loss: 0.0295 - output_8_loss: 0.0726 - output_9_loss: 0.2674 - output_10_loss: 0.0981 - output_11_loss: 0.0613 - output_2_sparse_categorical_accuracy: 0.9093 - output_3_sparse_categorical_accuracy: 0.9820 - output_4_sparse_categorical_accuracy: 0.9571 - output_5_sparse_categorical_accuracy: 0.9956 - output_6_sparse_categorical_accuracy: 0.9925 - output_7_sparse_categorical_accuracy: 0.9914 - output_8_sparse_categorical_accuracy: 0.9765 - output_9_sparse_categorical_accuracy: 0.9245 - output_10_sparse_categorical_accuracy: 0.9640 - output_11_sparse_categorical_accuracy: 0.9831
    Epoch 31/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1289 - output_1_loss: 0.0196 - output_2_loss: 0.3273 - output_3_loss: 0.0746 - output_4_loss: 0.1351 - output_5_loss: 0.0105 - output_6_loss: 0.0293 - output_7_loss: 0.0295 - output_8_loss: 0.0698 - output_9_loss: 0.2596 - output_10_loss: 0.0963 - output_11_loss: 0.0613 - output_2_sparse_categorical_accuracy: 0.9110 - output_3_sparse_categorical_accuracy: 0.9840 - output_4_sparse_categorical_accuracy: 0.9591 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9909 - output_7_sparse_categorical_accuracy: 0.9917 - output_8_sparse_categorical_accuracy: 0.9770 - output_9_sparse_categorical_accuracy: 0.9251 - output_10_sparse_categorical_accuracy: 0.9652 - output_11_sparse_categorical_accuracy: 0.9834
    Epoch 32/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1263 - output_1_loss: 0.0195 - output_2_loss: 0.3188 - output_3_loss: 0.0716 - output_4_loss: 0.1340 - output_5_loss: 0.0105 - output_6_loss: 0.0277 - output_7_loss: 0.0284 - output_8_loss: 0.0679 - output_9_loss: 0.2542 - output_10_loss: 0.0954 - output_11_loss: 0.0594 - output_2_sparse_categorical_accuracy: 0.9143 - output_3_sparse_categorical_accuracy: 0.9845 - output_4_sparse_categorical_accuracy: 0.9574 - output_5_sparse_categorical_accuracy: 0.9956 - output_6_sparse_categorical_accuracy: 0.9925 - output_7_sparse_categorical_accuracy: 0.9923 - output_8_sparse_categorical_accuracy: 0.9770 - output_9_sparse_categorical_accuracy: 0.9306 - output_10_sparse_categorical_accuracy: 0.9632 - output_11_sparse_categorical_accuracy: 0.9834
    Epoch 33/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1228 - output_1_loss: 0.0191 - output_2_loss: 0.3081 - output_3_loss: 0.0679 - output_4_loss: 0.1321 - output_5_loss: 0.0102 - output_6_loss: 0.0269 - output_7_loss: 0.0285 - output_8_loss: 0.0660 - output_9_loss: 0.2470 - output_10_loss: 0.0931 - output_11_loss: 0.0580 - output_2_sparse_categorical_accuracy: 0.9151 - output_3_sparse_categorical_accuracy: 0.9867 - output_4_sparse_categorical_accuracy: 0.9580 - output_5_sparse_categorical_accuracy: 0.9959 - output_6_sparse_categorical_accuracy: 0.9925 - output_7_sparse_categorical_accuracy: 0.9917 - output_8_sparse_categorical_accuracy: 0.9790 - output_9_sparse_categorical_accuracy: 0.9295 - output_10_sparse_categorical_accuracy: 0.9640 - output_11_sparse_categorical_accuracy: 0.9840
    Epoch 34/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1200 - output_1_loss: 0.0190 - output_2_loss: 0.3008 - output_3_loss: 0.0633 - output_4_loss: 0.1287 - output_5_loss: 0.0099 - output_6_loss: 0.0260 - output_7_loss: 0.0273 - output_8_loss: 0.0625 - output_9_loss: 0.2420 - output_10_loss: 0.0928 - output_11_loss: 0.0573 - output_2_sparse_categorical_accuracy: 0.9195 - output_3_sparse_categorical_accuracy: 0.9889 - output_4_sparse_categorical_accuracy: 0.9591 - output_5_sparse_categorical_accuracy: 0.9953 - output_6_sparse_categorical_accuracy: 0.9934 - output_7_sparse_categorical_accuracy: 0.9928 - output_8_sparse_categorical_accuracy: 0.9804 - output_9_sparse_categorical_accuracy: 0.9314 - output_10_sparse_categorical_accuracy: 0.9649 - output_11_sparse_categorical_accuracy: 0.9829
    Epoch 35/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1168 - output_1_loss: 0.0185 - output_2_loss: 0.2916 - output_3_loss: 0.0601 - output_4_loss: 0.1274 - output_5_loss: 0.0098 - output_6_loss: 0.0249 - output_7_loss: 0.0271 - output_8_loss: 0.0604 - output_9_loss: 0.2358 - output_10_loss: 0.0904 - output_11_loss: 0.0556 - output_2_sparse_categorical_accuracy: 0.9187 - output_3_sparse_categorical_accuracy: 0.9889 - output_4_sparse_categorical_accuracy: 0.9602 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9942 - output_7_sparse_categorical_accuracy: 0.9925 - output_8_sparse_categorical_accuracy: 0.9804 - output_9_sparse_categorical_accuracy: 0.9320 - output_10_sparse_categorical_accuracy: 0.9676 - output_11_sparse_categorical_accuracy: 0.9842
    Epoch 36/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1143 - output_1_loss: 0.0182 - output_2_loss: 0.2848 - output_3_loss: 0.0584 - output_4_loss: 0.1259 - output_5_loss: 0.0102 - output_6_loss: 0.0242 - output_7_loss: 0.0258 - output_8_loss: 0.0592 - output_9_loss: 0.2289 - output_10_loss: 0.0887 - output_11_loss: 0.0547 - output_2_sparse_categorical_accuracy: 0.9234 - output_3_sparse_categorical_accuracy: 0.9898 - output_4_sparse_categorical_accuracy: 0.9605 - output_5_sparse_categorical_accuracy: 0.9959 - output_6_sparse_categorical_accuracy: 0.9942 - output_7_sparse_categorical_accuracy: 0.9928 - output_8_sparse_categorical_accuracy: 0.9820 - output_9_sparse_categorical_accuracy: 0.9347 - output_10_sparse_categorical_accuracy: 0.9665 - output_11_sparse_categorical_accuracy: 0.9851
    Epoch 37/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1120 - output_1_loss: 0.0182 - output_2_loss: 0.2766 - output_3_loss: 0.0550 - output_4_loss: 0.1239 - output_5_loss: 0.0099 - output_6_loss: 0.0237 - output_7_loss: 0.0261 - output_8_loss: 0.0567 - output_9_loss: 0.2256 - output_10_loss: 0.0874 - output_11_loss: 0.0536 - output_2_sparse_categorical_accuracy: 0.9264 - output_3_sparse_categorical_accuracy: 0.9917 - output_4_sparse_categorical_accuracy: 0.9591 - output_5_sparse_categorical_accuracy: 0.9964 - output_6_sparse_categorical_accuracy: 0.9936 - output_7_sparse_categorical_accuracy: 0.9931 - output_8_sparse_categorical_accuracy: 0.9820 - output_9_sparse_categorical_accuracy: 0.9361 - output_10_sparse_categorical_accuracy: 0.9674 - output_11_sparse_categorical_accuracy: 0.9840
    Epoch 38/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1094 - output_1_loss: 0.0177 - output_2_loss: 0.2688 - output_3_loss: 0.0526 - output_4_loss: 0.1223 - output_5_loss: 0.0100 - output_6_loss: 0.0228 - output_7_loss: 0.0255 - output_8_loss: 0.0558 - output_9_loss: 0.2199 - output_10_loss: 0.0863 - output_11_loss: 0.0529 - output_2_sparse_categorical_accuracy: 0.9264 - output_3_sparse_categorical_accuracy: 0.9912 - output_4_sparse_categorical_accuracy: 0.9607 - output_5_sparse_categorical_accuracy: 0.9964 - output_6_sparse_categorical_accuracy: 0.9936 - output_7_sparse_categorical_accuracy: 0.9931 - output_8_sparse_categorical_accuracy: 0.9842 - output_9_sparse_categorical_accuracy: 0.9408 - output_10_sparse_categorical_accuracy: 0.9671 - output_11_sparse_categorical_accuracy: 0.9848
    Epoch 39/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1068 - output_1_loss: 0.0176 - output_2_loss: 0.2610 - output_3_loss: 0.0492 - output_4_loss: 0.1193 - output_5_loss: 0.0100 - output_6_loss: 0.0219 - output_7_loss: 0.0244 - output_8_loss: 0.0535 - output_9_loss: 0.2161 - output_10_loss: 0.0854 - output_11_loss: 0.0514 - output_2_sparse_categorical_accuracy: 0.9317 - output_3_sparse_categorical_accuracy: 0.9923 - output_4_sparse_categorical_accuracy: 0.9627 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9953 - output_7_sparse_categorical_accuracy: 0.9931 - output_8_sparse_categorical_accuracy: 0.9840 - output_9_sparse_categorical_accuracy: 0.9394 - output_10_sparse_categorical_accuracy: 0.9682 - output_11_sparse_categorical_accuracy: 0.9840
    Epoch 40/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1050 - output_1_loss: 0.0177 - output_2_loss: 0.2524 - output_3_loss: 0.0471 - output_4_loss: 0.1179 - output_5_loss: 0.0096 - output_6_loss: 0.0222 - output_7_loss: 0.0243 - output_8_loss: 0.0526 - output_9_loss: 0.2125 - output_10_loss: 0.0843 - output_11_loss: 0.0500 - output_2_sparse_categorical_accuracy: 0.9328 - output_3_sparse_categorical_accuracy: 0.9925 - output_4_sparse_categorical_accuracy: 0.9632 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9942 - output_7_sparse_categorical_accuracy: 0.9934 - output_8_sparse_categorical_accuracy: 0.9848 - output_9_sparse_categorical_accuracy: 0.9411 - output_10_sparse_categorical_accuracy: 0.9665 - output_11_sparse_categorical_accuracy: 0.9859
    Epoch 41/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1025 - output_1_loss: 0.0173 - output_2_loss: 0.2476 - output_3_loss: 0.0444 - output_4_loss: 0.1172 - output_5_loss: 0.0100 - output_6_loss: 0.0207 - output_7_loss: 0.0232 - output_8_loss: 0.0504 - output_9_loss: 0.2061 - output_10_loss: 0.0835 - output_11_loss: 0.0490 - output_2_sparse_categorical_accuracy: 0.9345 - output_3_sparse_categorical_accuracy: 0.9934 - output_4_sparse_categorical_accuracy: 0.9610 - output_5_sparse_categorical_accuracy: 0.9964 - output_6_sparse_categorical_accuracy: 0.9936 - output_7_sparse_categorical_accuracy: 0.9936 - output_8_sparse_categorical_accuracy: 0.9856 - output_9_sparse_categorical_accuracy: 0.9439 - output_10_sparse_categorical_accuracy: 0.9693 - output_11_sparse_categorical_accuracy: 0.9864
    Epoch 42/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.1002 - output_1_loss: 0.0168 - output_2_loss: 0.2398 - output_3_loss: 0.0420 - output_4_loss: 0.1138 - output_5_loss: 0.0097 - output_6_loss: 0.0210 - output_7_loss: 0.0239 - output_8_loss: 0.0495 - output_9_loss: 0.2020 - output_10_loss: 0.0833 - output_11_loss: 0.0489 - output_2_sparse_categorical_accuracy: 0.9378 - output_3_sparse_categorical_accuracy: 0.9947 - output_4_sparse_categorical_accuracy: 0.9649 - output_5_sparse_categorical_accuracy: 0.9967 - output_6_sparse_categorical_accuracy: 0.9942 - output_7_sparse_categorical_accuracy: 0.9928 - output_8_sparse_categorical_accuracy: 0.9862 - output_9_sparse_categorical_accuracy: 0.9436 - output_10_sparse_categorical_accuracy: 0.9674 - output_11_sparse_categorical_accuracy: 0.9853
    Epoch 43/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.0989 - output_1_loss: 0.0171 - output_2_loss: 0.2347 - output_3_loss: 0.0415 - output_4_loss: 0.1120 - output_5_loss: 0.0097 - output_6_loss: 0.0202 - output_7_loss: 0.0233 - output_8_loss: 0.0484 - output_9_loss: 0.1986 - output_10_loss: 0.0815 - output_11_loss: 0.0480 - output_2_sparse_categorical_accuracy: 0.9386 - output_3_sparse_categorical_accuracy: 0.9945 - output_4_sparse_categorical_accuracy: 0.9649 - output_5_sparse_categorical_accuracy: 0.9967 - output_6_sparse_categorical_accuracy: 0.9942 - output_7_sparse_categorical_accuracy: 0.9939 - output_8_sparse_categorical_accuracy: 0.9867 - output_9_sparse_categorical_accuracy: 0.9439 - output_10_sparse_categorical_accuracy: 0.9707 - output_11_sparse_categorical_accuracy: 0.9856
    Epoch 44/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.0961 - output_1_loss: 0.0165 - output_2_loss: 0.2270 - output_3_loss: 0.0389 - output_4_loss: 0.1092 - output_5_loss: 0.0094 - output_6_loss: 0.0200 - output_7_loss: 0.0222 - output_8_loss: 0.0482 - output_9_loss: 0.1953 - output_10_loss: 0.0790 - output_11_loss: 0.0462 - output_2_sparse_categorical_accuracy: 0.9392 - output_3_sparse_categorical_accuracy: 0.9953 - output_4_sparse_categorical_accuracy: 0.9643 - output_5_sparse_categorical_accuracy: 0.9970 - output_6_sparse_categorical_accuracy: 0.9936 - output_7_sparse_categorical_accuracy: 0.9939 - output_8_sparse_categorical_accuracy: 0.9870 - output_9_sparse_categorical_accuracy: 0.9461 - output_10_sparse_categorical_accuracy: 0.9707 - output_11_sparse_categorical_accuracy: 0.9867
    Epoch 45/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.0943 - output_1_loss: 0.0163 - output_2_loss: 0.2218 - output_3_loss: 0.0375 - output_4_loss: 0.1074 - output_5_loss: 0.0098 - output_6_loss: 0.0191 - output_7_loss: 0.0213 - output_8_loss: 0.0456 - output_9_loss: 0.1922 - output_10_loss: 0.0795 - output_11_loss: 0.0458 - output_2_sparse_categorical_accuracy: 0.9408 - output_3_sparse_categorical_accuracy: 0.9942 - output_4_sparse_categorical_accuracy: 0.9657 - output_5_sparse_categorical_accuracy: 0.9964 - output_6_sparse_categorical_accuracy: 0.9939 - output_7_sparse_categorical_accuracy: 0.9950 - output_8_sparse_categorical_accuracy: 0.9870 - output_9_sparse_categorical_accuracy: 0.9461 - output_10_sparse_categorical_accuracy: 0.9710 - output_11_sparse_categorical_accuracy: 0.9878
    Epoch 46/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.0924 - output_1_loss: 0.0161 - output_2_loss: 0.2150 - output_3_loss: 0.0353 - output_4_loss: 0.1058 - output_5_loss: 0.0096 - output_6_loss: 0.0189 - output_7_loss: 0.0217 - output_8_loss: 0.0439 - output_9_loss: 0.1889 - output_10_loss: 0.0787 - output_11_loss: 0.0455 - output_2_sparse_categorical_accuracy: 0.9441 - output_3_sparse_categorical_accuracy: 0.9956 - output_4_sparse_categorical_accuracy: 0.9621 - output_5_sparse_categorical_accuracy: 0.9961 - output_6_sparse_categorical_accuracy: 0.9950 - output_7_sparse_categorical_accuracy: 0.9947 - output_8_sparse_categorical_accuracy: 0.9895 - output_9_sparse_categorical_accuracy: 0.9461 - output_10_sparse_categorical_accuracy: 0.9699 - output_11_sparse_categorical_accuracy: 0.9851
    Epoch 47/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.0909 - output_1_loss: 0.0164 - output_2_loss: 0.2096 - output_3_loss: 0.0341 - output_4_loss: 0.1025 - output_5_loss: 0.0096 - output_6_loss: 0.0179 - output_7_loss: 0.0204 - output_8_loss: 0.0438 - output_9_loss: 0.1846 - output_10_loss: 0.0774 - output_11_loss: 0.0446 - output_2_sparse_categorical_accuracy: 0.9447 - output_3_sparse_categorical_accuracy: 0.9956 - output_4_sparse_categorical_accuracy: 0.9693 - output_5_sparse_categorical_accuracy: 0.9972 - output_6_sparse_categorical_accuracy: 0.9956 - output_7_sparse_categorical_accuracy: 0.9945 - output_8_sparse_categorical_accuracy: 0.9887 - output_9_sparse_categorical_accuracy: 0.9488 - output_10_sparse_categorical_accuracy: 0.9726 - output_11_sparse_categorical_accuracy: 0.9870
    Epoch 48/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.0894 - output_1_loss: 0.0162 - output_2_loss: 0.2030 - output_3_loss: 0.0330 - output_4_loss: 0.1026 - output_5_loss: 0.0095 - output_6_loss: 0.0186 - output_7_loss: 0.0213 - output_8_loss: 0.0429 - output_9_loss: 0.1812 - output_10_loss: 0.0769 - output_11_loss: 0.0440 - output_2_sparse_categorical_accuracy: 0.9472 - output_3_sparse_categorical_accuracy: 0.9959 - output_4_sparse_categorical_accuracy: 0.9674 - output_5_sparse_categorical_accuracy: 0.9970 - output_6_sparse_categorical_accuracy: 0.9945 - output_7_sparse_categorical_accuracy: 0.9945 - output_8_sparse_categorical_accuracy: 0.9881 - output_9_sparse_categorical_accuracy: 0.9472 - output_10_sparse_categorical_accuracy: 0.9718 - output_11_sparse_categorical_accuracy: 0.9878
    Epoch 49/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.0879 - output_1_loss: 0.0160 - output_2_loss: 0.1992 - output_3_loss: 0.0313 - output_4_loss: 0.0994 - output_5_loss: 0.0092 - output_6_loss: 0.0177 - output_7_loss: 0.0201 - output_8_loss: 0.0420 - output_9_loss: 0.1797 - output_10_loss: 0.0765 - output_11_loss: 0.0436 - output_2_sparse_categorical_accuracy: 0.9475 - output_3_sparse_categorical_accuracy: 0.9959 - output_4_sparse_categorical_accuracy: 0.9690 - output_5_sparse_categorical_accuracy: 0.9972 - output_6_sparse_categorical_accuracy: 0.9945 - output_7_sparse_categorical_accuracy: 0.9945 - output_8_sparse_categorical_accuracy: 0.9870 - output_9_sparse_categorical_accuracy: 0.9508 - output_10_sparse_categorical_accuracy: 0.9718 - output_11_sparse_categorical_accuracy: 0.9870
    Epoch 50/50
    113/113 [==============================] - 0s 3ms/step - loss: 0.0859 - output_1_loss: 0.0158 - output_2_loss: 0.1920 - output_3_loss: 0.0305 - output_4_loss: 0.0975 - output_5_loss: 0.0087 - output_6_loss: 0.0177 - output_7_loss: 0.0197 - output_8_loss: 0.0402 - output_9_loss: 0.1780 - output_10_loss: 0.0750 - output_11_loss: 0.0415 - output_2_sparse_categorical_accuracy: 0.9463 - output_3_sparse_categorical_accuracy: 0.9967 - output_4_sparse_categorical_accuracy: 0.9679 - output_5_sparse_categorical_accuracy: 0.9975 - output_6_sparse_categorical_accuracy: 0.9947 - output_7_sparse_categorical_accuracy: 0.9956 - output_8_sparse_categorical_accuracy: 0.9892 - output_9_sparse_categorical_accuracy: 0.9499 - output_10_sparse_categorical_accuracy: 0.9712 - output_11_sparse_categorical_accuracy: 0.9876





    <keras.src.callbacks.History at 0x7ac1887d89d0>



## 5. CFRL 동기화

`COEF_SPARSITY`는 $\theta_1$ 즉 $L_1(\delta)$의 가중치이다. $\delta$를 최소로 하여 cf가 원래 특성변수값에 근접하도록 한다.

`COEF_CONSISTENCY`는 $\theta_2$ 즉 $L_2(x+\delta, AE(x+\delta))$의 가중치이다. 이는 cf가 학습데이터와 분포적으로 동일하도록 규제한다.


```python
COEFF_SPARSITY=0.5
COEFF_CONSISTENCY=0.5
TRAIN_STEPS=10000
BATCH_SIZE=100
```

`immutable_features`: cf 생성 시 변하지 않아야 할 특성변수를 지정한다.
- 고객의 개인특성(직업, 혼인상태, 학력, 신용불량여부)과 과거 마케팅캠페인에 관한 데이터는 변동할 수 없다.

`ranges`: Age는 증가만 가능하도록 허용한다. education 변수도 증가만 가능해야 하지만 CounterfactualRLTabular 클래스의 인스턴스화에 사용되는 ranges 파라미터는 실수형 변수에 대해서만 증감을 제한한다.
- 고객의 연령(age)과 이번 마케팅캠페인의 고객접촉횟수(campaign)는 증가만 할 수 있다.


```python
"""
CATEGORICAL: job	marital	education	default	housing	loan	contact	month	poutcome	day_cat
NUMERIC: age	balance	duration	campaign	pdays	previous
"""
immutable_features = ['job', 'marital', 'education', 'default', 'previous', 'poutcome'] # 혼인상태, 학력, 신용불량여부, 이전 캠페인에서 접촉 횟수, 이전 캠페인의 결과
ranges = {'age': [0, 1],
          'campaign': [0,1] # 현재 캠페인에서 고객과 접촉한 횟수
          }
```

CFRL을 동기화 하고, 강화학습 모형을 학습시켜야 하므로 .fit() 을 실행한다.


```python
explainer = CounterfactualRLTabular(predictor = predictor,
                                    encoder = heae.encoder,
                                    decoder = heae.decoder,
                                    latent_dim = LATENT_DIM,
                                    encoder_preprocessor = heae_preprocessor,
                                    decoder_inv_preprocessor = heae_inv_preprocessor,
                                    coeff_sparsity = COEFF_SPARSITY,
                                    coeff_consistency = COEFF_CONSISTENCY,
                                    category_map = category_map,
                                    feature_names = feature_names,
                                    ranges = ranges,
                                    immutable_features = immutable_features,
                                    train_steps = TRAIN_STEPS,
                                    batch_size = BATCH_SIZE)

explainer = explainer.fit(X=X_train)
```

    100%|██████████| 10000/10000 [10:35<00:00, 15.73it/s]


## 6. CFRL 구하기

CFRL은 2개 이상의 표본에 대하여 cf를 생성할 수 있다.

X_test의 예측 레이블이 0인 표본(즉, 정기예금 상품에 가입하지 않을 것으로 예측되는 표본)을 X_negative로 정의하고 이중 100개를 선택하여 예측 레이블이 1이 되는 CFRL을 구하자. `Y_t = np.array([1])`
- age는 0~10세 증가할 수 있게 한다
- campaign은 0~2만큼만 증가할 수 있게 한다. 은행이 고객에게 연락을 너무 많이 하면 또다른 CS 이슈가 발생할 수 있으니까.


```python
X_negative = X_test[np.argmax(predictor(X_test), axis=1) == 0]
X = X_negative[:100]
# target label: 1
Y_t = np.array([1])
C = [{'age': [0, 10], 'campaign': [0, 2]}]

explanation = explainer.explain(X, Y_t, C)
```

    100%|██████████| 1/1 [00:00<00:00, 23.76it/s]


다음 프로그램은 apply_category_mapping을 통해 순서형 정수를 범주값으로 바꾸고, 원표본 100개와 cf 100개를 각각 데이터프레임으로 만든다.


```python
orig = np.concatenate([explanation.data['orig']['X'], explanation.data['orig']['class']], axis=1)

cf = np.concatenate([explanation.data['cf']['X'], explanation.data['cf']['class']], axis=1)

# category map 업데이트 하기(목적변수 추가)
feature_names = feature_names + ['Label']
target_names = ['no', 'yes']
category_map = deepcopy(category_map) # deepcopy: 새로운 메모리 주소에 인스턴스 생성
category_map.update({feature_names.index("Label"): target_names})

# 순서형 정수로 인코딩된 범주값을 문자열로 바꾸기
orig_pd = pd.DataFrame(apply_category_mapping(orig, category_map), columns=feature_names)
cf_pd = pd.DataFrame(apply_category_mapping(cf, category_map), columns=feature_names)
```

    /usr/local/lib/python3.10/dist-packages/alibi/explainers/backends/cfrl_tabular.py:877: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
    The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.
    
    For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.
    
    
      pd_X[key].replace(range(len(category_map[key])), category_map[key], inplace=True)



```python
orig_pd.head(5)
```





  <div id="df-96e376c5-3bce-425d-a927-220a05400d35" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>entrepreneur</td>
      <td>married</td>
      <td>secondary</td>
      <td>yes</td>
      <td>no</td>
      <td>yes</td>
      <td>cellular</td>
      <td>jul</td>
      <td>unknown</td>
      <td>late</td>
      <td>51.0</td>
      <td>-2082.0</td>
      <td>123.0</td>
      <td>6.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>1</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>other</td>
      <td>early</td>
      <td>50.0</td>
      <td>2881.0</td>
      <td>510.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>5.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>2</th>
      <td>technician</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>unknown</td>
      <td>early</td>
      <td>50.0</td>
      <td>1412.0</td>
      <td>131.0</td>
      <td>3.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>3</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
      <td>unknown</td>
      <td>jun</td>
      <td>unknown</td>
      <td>early</td>
      <td>37.0</td>
      <td>0.0</td>
      <td>247.0</td>
      <td>13.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>4</th>
      <td>admin.</td>
      <td>single</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>feb</td>
      <td>unknown</td>
      <td>early</td>
      <td>31.0</td>
      <td>757.0</td>
      <td>343.0</td>
      <td>2.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-96e376c5-3bce-425d-a927-220a05400d35')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-96e376c5-3bce-425d-a927-220a05400d35 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-96e376c5-3bce-425d-a927-220a05400d35');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-e330f3e5-c9cb-4d65-9cc3-297f99c83457">
  <button class="colab-df-quickchart" onclick="quickchart('df-e330f3e5-c9cb-4d65-9cc3-297f99c83457')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-e330f3e5-c9cb-4d65-9cc3-297f99c83457 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>





```python
cf_pd.head(5)
```





  <div id="df-d2b2168f-21bf-4091-9817-3953645b29f8" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>entrepreneur</td>
      <td>married</td>
      <td>secondary</td>
      <td>yes</td>
      <td>no</td>
      <td>yes</td>
      <td>cellular</td>
      <td>jul</td>
      <td>unknown</td>
      <td>mid</td>
      <td>51.171792</td>
      <td>-1746.000141</td>
      <td>177.970766</td>
      <td>6.0</td>
      <td>7.759286</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>1</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>other</td>
      <td>early</td>
      <td>50.108274</td>
      <td>2099.090321</td>
      <td>513.311777</td>
      <td>2.276312</td>
      <td>22.545976</td>
      <td>5.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>2</th>
      <td>technician</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>unknown</td>
      <td>early</td>
      <td>50.053603</td>
      <td>1324.822779</td>
      <td>130.641457</td>
      <td>3.286392</td>
      <td>4.611033</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>3</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
      <td>unknown</td>
      <td>jun</td>
      <td>unknown</td>
      <td>early</td>
      <td>37.0</td>
      <td>169.334007</td>
      <td>239.063277</td>
      <td>13.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>4</th>
      <td>admin.</td>
      <td>single</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>feb</td>
      <td>unknown</td>
      <td>early</td>
      <td>31.0</td>
      <td>907.22132</td>
      <td>343.816504</td>
      <td>2.239352</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-d2b2168f-21bf-4091-9817-3953645b29f8')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-d2b2168f-21bf-4091-9817-3953645b29f8 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-d2b2168f-21bf-4091-9817-3953645b29f8');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-cc51962b-cc2e-4e0c-89dd-b8685ed9a478">
  <button class="colab-df-quickchart" onclick="quickchart('df-cc51962b-cc2e-4e0c-89dd-b8685ed9a478')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-cc51962b-cc2e-4e0c-89dd-b8685ed9a478 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>




제한조건이 많아서인지, 레이블 NO로 예측된 100개 표본 중 단 2개에 대해서만 counterfactual을 구할 수 있었다.


```python
cf_pd['Label'].value_counts()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>Label</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>no</th>
      <td>98</td>
    </tr>
    <tr>
      <th>yes</th>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> int64</label>



## 7. 조건을 완화하여 CFRL 다시 동기화

theta_1, theta_2를 각각 0.1로 낮추어 규제화 정도를 약화하였다. 원본 특성변수값 혹은 학습데이터의 분포와 좀더 다른 counterfactual도 생성될 수 있도록 하기 위함이다. 직업은 unemployed, student, retired, unknown 중 하나의 직업군으로 변하도록 제한조건을 부여하였다(이전 실행에서는 직업을 고정하였다). 또한 연령은 0~20세까지 증가할 수 있도록 하였고 고객 컨택 횟수는 0~3회까지 증가할 수 있도록 제한조건을 약간 완화하였다.


```python
COEFF_SPARSITY=0.1
COEFF_CONSISTENCY=0.1
TRAIN_STEPS=10000
BATCH_SIZE=100

"""
CATEGORICAL: job	marital	education	default	housing	loan	contact	month	poutcome	day_cat
NUMERIC: age	balance	duration	campaign	pdays	previous
"""
immutable_features = ['marital', 'education', 'default', 'previous', 'poutcome'] # 혼인상태, 학력, 신용불량여부, 이전 캠페인에서 접촉 횟수, 이전 캠페인의 결과
ranges = {'age': [0, 1],
          'campaign': [0,1], # 현재 캠페인에서 고객과 접촉한 횟수
          'job': ['unemployed', 'student', 'retired', 'unknown']
          }

explainer = CounterfactualRLTabular(predictor = predictor,
                                    encoder = heae.encoder,
                                    decoder = heae.decoder,
                                    latent_dim = LATENT_DIM,
                                    encoder_preprocessor = heae_preprocessor,
                                    decoder_inv_preprocessor = heae_inv_preprocessor,
                                    coeff_sparsity = COEFF_SPARSITY,
                                    coeff_consistency = COEFF_CONSISTENCY,
                                    category_map = category_map,
                                    feature_names = feature_names,
                                    ranges = ranges,
                                    immutable_features = immutable_features,
                                    train_steps = TRAIN_STEPS,
                                    batch_size = BATCH_SIZE)

explainer = explainer.fit(X=X_train)
```

    100%|██████████| 10000/10000 [10:37<00:00, 15.69it/s]



```python
X_negative = X_test[np.argmax(predictor(X_test), axis=1) == 0]
X = X_negative[:100]
# target label: 1
Y_t = np.array([1])
C = [{'age': [0, 20], 'campaign': [0, 3]}]

explanation = explainer.explain(X, Y_t, C)
```

    100%|██████████| 1/1 [00:00<00:00, 28.59it/s]



```python
orig = np.concatenate([explanation.data['orig']['X'], explanation.data['orig']['class']], axis=1)

cf = np.concatenate([explanation.data['cf']['X'], explanation.data['cf']['class']], axis=1)

# category map 업데이트 하기(목적변수 추가)
feature_names = feature_names + ['Label']
target_names = ['no', 'yes']
category_map = deepcopy(category_map) # deepcopy: 새로운 메모리 주소에 인스턴스 생성
category_map.update({feature_names.index("Label"): target_names})

# 순서형 정수로 인코딩된 범주값을 문자열로 바꾸기
orig_pd = pd.DataFrame(apply_category_mapping(orig, category_map), columns=feature_names)
cf_pd = pd.DataFrame(apply_category_mapping(cf, category_map), columns=feature_names)
```

    /usr/local/lib/python3.10/dist-packages/alibi/explainers/backends/cfrl_tabular.py:877: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
    The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.
    
    For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.
    
    
      pd_X[key].replace(range(len(category_map[key])), category_map[key], inplace=True)



```python
orig_pd.head(10)
```





  <div id="df-3424aa74-8046-4261-9036-4c52424ecd40" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>entrepreneur</td>
      <td>married</td>
      <td>secondary</td>
      <td>yes</td>
      <td>no</td>
      <td>yes</td>
      <td>cellular</td>
      <td>jul</td>
      <td>unknown</td>
      <td>late</td>
      <td>51.0</td>
      <td>-2082.0</td>
      <td>123.0</td>
      <td>6.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>1</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>other</td>
      <td>early</td>
      <td>50.0</td>
      <td>2881.0</td>
      <td>510.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>5.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>2</th>
      <td>technician</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>unknown</td>
      <td>early</td>
      <td>50.0</td>
      <td>1412.0</td>
      <td>131.0</td>
      <td>3.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>3</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
      <td>unknown</td>
      <td>jun</td>
      <td>unknown</td>
      <td>early</td>
      <td>37.0</td>
      <td>0.0</td>
      <td>247.0</td>
      <td>13.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>4</th>
      <td>admin.</td>
      <td>single</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>feb</td>
      <td>unknown</td>
      <td>early</td>
      <td>31.0</td>
      <td>757.0</td>
      <td>343.0</td>
      <td>2.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>5</th>
      <td>admin.</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>may</td>
      <td>failure</td>
      <td>mid</td>
      <td>39.0</td>
      <td>-650.0</td>
      <td>123.0</td>
      <td>2.0</td>
      <td>364.0</td>
      <td>1.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>6</th>
      <td>admin.</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
      <td>cellular</td>
      <td>apr</td>
      <td>unknown</td>
      <td>mid</td>
      <td>41.0</td>
      <td>5110.0</td>
      <td>231.0</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>7</th>
      <td>admin.</td>
      <td>divorced</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>may</td>
      <td>other</td>
      <td>mid</td>
      <td>31.0</td>
      <td>360.0</td>
      <td>332.0</td>
      <td>1.0</td>
      <td>297.0</td>
      <td>2.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>8</th>
      <td>technician</td>
      <td>single</td>
      <td>tertiary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>feb</td>
      <td>unknown</td>
      <td>early</td>
      <td>31.0</td>
      <td>454.0</td>
      <td>73.0</td>
      <td>3.0</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>9</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>mar</td>
      <td>failure</td>
      <td>mid</td>
      <td>37.0</td>
      <td>0.0</td>
      <td>129.0</td>
      <td>4.0</td>
      <td>107.0</td>
      <td>2.0</td>
      <td>no</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-3424aa74-8046-4261-9036-4c52424ecd40')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-3424aa74-8046-4261-9036-4c52424ecd40 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-3424aa74-8046-4261-9036-4c52424ecd40');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-178aa40a-62c2-4bc9-b643-905e3669433a">
  <button class="colab-df-quickchart" onclick="quickchart('df-178aa40a-62c2-4bc9-b643-905e3669433a')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-178aa40a-62c2-4bc9-b643-905e3669433a button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>





```python
cf_pd.head(10)
```





  <div id="df-920ed3d3-1f40-4fba-ad3d-4830f6734434" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>entrepreneur</td>
      <td>married</td>
      <td>secondary</td>
      <td>yes</td>
      <td>yes</td>
      <td>yes</td>
      <td>cellular</td>
      <td>aug</td>
      <td>unknown</td>
      <td>late</td>
      <td>52.712137</td>
      <td>-1746.000141</td>
      <td>92.5786</td>
      <td>6.0</td>
      <td>8.374012</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>1</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>other</td>
      <td>early</td>
      <td>50.354218</td>
      <td>2331.198414</td>
      <td>484.759748</td>
      <td>2.072403</td>
      <td>40.726143</td>
      <td>5.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>2</th>
      <td>technician</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>unknown</td>
      <td>early</td>
      <td>50.418595</td>
      <td>1446.502151</td>
      <td>134.821164</td>
      <td>3.0</td>
      <td>3.786475</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>3</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
      <td>unknown</td>
      <td>jun</td>
      <td>unknown</td>
      <td>early</td>
      <td>37.0</td>
      <td>301.860751</td>
      <td>218.374873</td>
      <td>13.0</td>
      <td>10.835063</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>4</th>
      <td>admin.</td>
      <td>single</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>feb</td>
      <td>unknown</td>
      <td>early</td>
      <td>31.269862</td>
      <td>856.063735</td>
      <td>331.255228</td>
      <td>2.0</td>
      <td>8.87659</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>5</th>
      <td>admin.</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>may</td>
      <td>failure</td>
      <td>mid</td>
      <td>39.442717</td>
      <td>-725.191141</td>
      <td>97.031301</td>
      <td>2.143867</td>
      <td>353.854774</td>
      <td>1.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>6</th>
      <td>admin.</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
      <td>cellular</td>
      <td>apr</td>
      <td>unknown</td>
      <td>mid</td>
      <td>41.134654</td>
      <td>4988.577247</td>
      <td>209.49685</td>
      <td>1.0</td>
      <td>4.707964</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>7</th>
      <td>admin.</td>
      <td>divorced</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>may</td>
      <td>other</td>
      <td>mid</td>
      <td>32.535061</td>
      <td>259.49417</td>
      <td>303.167226</td>
      <td>1.338418</td>
      <td>294.068386</td>
      <td>2.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>8</th>
      <td>technician</td>
      <td>single</td>
      <td>tertiary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>feb</td>
      <td>unknown</td>
      <td>early</td>
      <td>31.953464</td>
      <td>529.603574</td>
      <td>69.314435</td>
      <td>3.0</td>
      <td>6.261996</td>
      <td>0.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>9</th>
      <td>management</td>
      <td>married</td>
      <td>tertiary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>mar</td>
      <td>failure</td>
      <td>mid</td>
      <td>37.108863</td>
      <td>-467.506353</td>
      <td>89.334472</td>
      <td>4.051367</td>
      <td>101.834676</td>
      <td>2.0</td>
      <td>no</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-920ed3d3-1f40-4fba-ad3d-4830f6734434')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-920ed3d3-1f40-4fba-ad3d-4830f6734434 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-920ed3d3-1f40-4fba-ad3d-4830f6734434');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-fd7f235a-a0ab-49f9-a023-85285f12734c">
  <button class="colab-df-quickchart" onclick="quickchart('df-fd7f235a-a0ab-49f9-a023-85285f12734c')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-fd7f235a-a0ab-49f9-a023-85285f12734c button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>





```python
cf_pd['Label'].value_counts()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>Label</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>no</th>
      <td>98</td>
    </tr>
    <tr>
      <th>yes</th>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div><br><label><b>dtype:</b> int64</label>



6.번에서와 같은 방식으로 원표본과 cf 100개를 각각 데이터 프레임으로 만들고 cf가 구해진 표본의 수를 세면, 이전 실행과 마찬가지로 Label이 yes인 표본은 2개이다. 제한조건을 소폭 완화해도 cf을 구하기는 쉽지 않다. 

한편 인덱스 35와 41에 대해서는 cf가 구해졌다. 표본의 원래 특성변수값과 비교하면, 두 표본 모두 ▲직업(job)이 ‘unknown’으로 변하고 ▲나이(age)가 약간 증가하고 ▲통장 잔고(balance)가 증가하고 ▲컨택의 통화시간(duration)이 길어지고 ▲이번 캠페인의 접촉(campaign)을 한 번 늘리고 ▲이전 마케팅캠페인으로부터 덜 경과한 시점(pdays)에 컨택했다면 정기예금 상품에 가입했을 것으로 예측되었다. 


```python
cf_pd[cf_pd['Label']=='yes']
```





  <div id="df-00279134-f253-4de1-b7df-5a1d6256161b" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>35</th>
      <td>unknown</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>oct</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4298.815915</td>
      <td>823.81039</td>
      <td>2.124269</td>
      <td>176.956274</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>41</th>
      <td>unknown</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>dec</td>
      <td>success</td>
      <td>mid</td>
      <td>36.843357</td>
      <td>2170.739222</td>
      <td>1305.3512</td>
      <td>1.807006</td>
      <td>164.917132</td>
      <td>6.0</td>
      <td>yes</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-00279134-f253-4de1-b7df-5a1d6256161b')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-00279134-f253-4de1-b7df-5a1d6256161b button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-00279134-f253-4de1-b7df-5a1d6256161b');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-7d98006e-a97f-4a3a-aefb-9b5918489a71">
  <button class="colab-df-quickchart" onclick="quickchart('df-7d98006e-a97f-4a3a-aefb-9b5918489a71')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-7d98006e-a97f-4a3a-aefb-9b5918489a71 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>





```python
orig_pd.loc[[35, 41]]
```





  <div id="df-105e8099-3e9c-47cf-bbb8-1c55fe759314" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>35</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>apr</td>
      <td>success</td>
      <td>mid</td>
      <td>75.0</td>
      <td>3771.0</td>
      <td>185.0</td>
      <td>1.0</td>
      <td>181.0</td>
      <td>2.0</td>
      <td>no</td>
    </tr>
    <tr>
      <th>41</th>
      <td>services</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>may</td>
      <td>success</td>
      <td>mid</td>
      <td>34.0</td>
      <td>1076.0</td>
      <td>152.0</td>
      <td>1.0</td>
      <td>182.0</td>
      <td>6.0</td>
      <td>no</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-105e8099-3e9c-47cf-bbb8-1c55fe759314')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-105e8099-3e9c-47cf-bbb8-1c55fe759314 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-105e8099-3e9c-47cf-bbb8-1c55fe759314');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-bddb3dcb-69c2-4f84-875f-010c880ef581">
  <button class="colab-df-quickchart" onclick="quickchart('df-bddb3dcb-69c2-4f84-875f-010c880ef581')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-bddb3dcb-69c2-4f84-875f-010c880ef581 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>




**하나의 표본에 대하여 여러개의 counterfactual 구하기**

다음은 정기예금 상품에 가입하지 않을 것으로 예측된 35번 표본에 대하여 여러개의 CFRL을 구하는 프로그램이다. diversity=True로 부여하고, num_samples=10을 지정하여 열 개의 cf를 구한다. 


```python
X = X_negative[35].reshape(1, -1)
explanation = explainer.explain(X=X, Y_t=Y_t, C=C, diversity=True, num_samples=10, batch_size=100)

orig = np.concatenate([explanation.data['orig']['X'], explanation.data['orig']['class']], axis=1)
cf = np.concatenate([explanation.data['cf']['X'], explanation.data['cf']['class']], axis=1)

orig_pd = pd.DataFrame(apply_category_mapping(orig, category_map), columns=feature_names)
cf_pd = pd.DataFrame(apply_category_mapping(cf, category_map), columns=feature_names)
```

    1it [00:00, 23.89it/s]
    /usr/local/lib/python3.10/dist-packages/alibi/explainers/backends/cfrl_tabular.py:877: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
    The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.
    
    For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.
    
    
      pd_X[key].replace(range(len(category_map[key])), category_map[key], inplace=True)



```python
orig_pd.head()
```





  <div id="df-8ece39e4-8c5c-4895-a2d8-14eb50ac6c81" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>apr</td>
      <td>success</td>
      <td>mid</td>
      <td>75.0</td>
      <td>3771.0</td>
      <td>185.0</td>
      <td>1.0</td>
      <td>181.0</td>
      <td>2.0</td>
      <td>no</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-8ece39e4-8c5c-4895-a2d8-14eb50ac6c81')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-8ece39e4-8c5c-4895-a2d8-14eb50ac6c81 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-8ece39e4-8c5c-4895-a2d8-14eb50ac6c81');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    </div>
  </div>




아래 데이터프레임은 인덱스 35 표본에 대하여 구한 10개의 cf를 보여준다. cf 전반에 거쳐 경향성이 존재하는데, 고객의 통장 잔고는 현재보다 높은 수준이어야 하고 컨택의 통화시간 또한 길어져야 한다. 그럼에도 은행이 이 고객에게 정기예금 상품을 판매하기 위해 여러 cf 중 쉽게 실현가능한 시나리오를 선택할 수 있다는 점에서 CFRL은 의의가 있다. 예를 들어 나흘 뒤에(pdays==185) 한번 더 컨택하여(campaign==1.8)  800초 이상 통화함으로써(duration==807) 고객이 정기예금 상품에 가입할 확률을 높일 수 있다. 


```python
cf_pd.head(10)
```





  <div id="df-be2503c1-5b52-485a-9539-7665903ab20c" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>apr</td>
      <td>success</td>
      <td>mid</td>
      <td>75.000001</td>
      <td>4572.11824</td>
      <td>807.764809</td>
      <td>1.853142</td>
      <td>185.624958</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>1</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>dec</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4443.198969</td>
      <td>836.134149</td>
      <td>1.037773</td>
      <td>179.452669</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>2</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>dec</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4497.567884</td>
      <td>850.038117</td>
      <td>2.137861</td>
      <td>179.150466</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>3</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>dec</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4502.672169</td>
      <td>849.145105</td>
      <td>2.034308</td>
      <td>185.801083</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>4</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>dec</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4544.667332</td>
      <td>550.791157</td>
      <td>2.004443</td>
      <td>180.528057</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>5</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>dec</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4574.388141</td>
      <td>853.189477</td>
      <td>1.886549</td>
      <td>184.557935</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>6</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>dec</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4582.875336</td>
      <td>435.020543</td>
      <td>1.151441</td>
      <td>183.966158</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>7</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>dec</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4583.943134</td>
      <td>864.700557</td>
      <td>1.914688</td>
      <td>187.831076</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>8</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>dec</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4611.841174</td>
      <td>809.092029</td>
      <td>2.155101</td>
      <td>182.342586</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>9</th>
      <td>retired</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>telephone</td>
      <td>dec</td>
      <td>success</td>
      <td>late</td>
      <td>75.000001</td>
      <td>4625.385448</td>
      <td>641.303014</td>
      <td>2.07055</td>
      <td>184.602933</td>
      <td>2.0</td>
      <td>yes</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-be2503c1-5b52-485a-9539-7665903ab20c')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-be2503c1-5b52-485a-9539-7665903ab20c button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-be2503c1-5b52-485a-9539-7665903ab20c');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-fda64715-b1e7-434f-a2a4-03fd895576a3">
  <button class="colab-df-quickchart" onclick="quickchart('df-fda64715-b1e7-434f-a2a4-03fd895576a3')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-fda64715-b1e7-434f-a2a4-03fd895576a3 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>




한편 인덱스 41에 대하여 여러 개의 CFRL 구하면 다음과 같다. 


```python
X = X_negative[41].reshape(1, -1)
explanation = explainer.explain(X=X, Y_t=Y_t, C=C, diversity=True, num_samples=10, batch_size=100)

orig = np.concatenate([explanation.data['orig']['X'], explanation.data['orig']['class']], axis=1)
cf = np.concatenate([explanation.data['cf']['X'], explanation.data['cf']['class']], axis=1)

orig_pd = pd.DataFrame(apply_category_mapping(orig, category_map), columns=feature_names)
cf_pd = pd.DataFrame(apply_category_mapping(cf, category_map), columns=feature_names)
```

    1it [00:00, 23.19it/s]
    /usr/local/lib/python3.10/dist-packages/alibi/explainers/backends/cfrl_tabular.py:877: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
    The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.
    
    For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.
    
    
      pd_X[key].replace(range(len(category_map[key])), category_map[key], inplace=True)



```python
orig_pd.head()
```





  <div id="df-e1a911d9-8828-4d4a-b87d-c674b70a25fe" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>services</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>may</td>
      <td>success</td>
      <td>mid</td>
      <td>34.0</td>
      <td>1076.0</td>
      <td>152.0</td>
      <td>1.0</td>
      <td>182.0</td>
      <td>6.0</td>
      <td>no</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-e1a911d9-8828-4d4a-b87d-c674b70a25fe')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-e1a911d9-8828-4d4a-b87d-c674b70a25fe button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-e1a911d9-8828-4d4a-b87d-c674b70a25fe');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    </div>
  </div>





```python
cf_pd.head()
```





  <div id="df-79659ecc-77ce-42ef-ac0f-65a63a9fe005" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job</th>
      <th>marital</th>
      <th>education</th>
      <th>default</th>
      <th>housing</th>
      <th>loan</th>
      <th>contact</th>
      <th>month</th>
      <th>poutcome</th>
      <th>day_cat</th>
      <th>age</th>
      <th>balance</th>
      <th>duration</th>
      <th>campaign</th>
      <th>pdays</th>
      <th>previous</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>admin.</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>success</td>
      <td>mid</td>
      <td>36.051669</td>
      <td>2414.817902</td>
      <td>786.214626</td>
      <td>1.203718</td>
      <td>176.070671</td>
      <td>6.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>1</th>
      <td>admin.</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>aug</td>
      <td>success</td>
      <td>mid</td>
      <td>36.147542</td>
      <td>2573.402631</td>
      <td>1338.9051</td>
      <td>1.465826</td>
      <td>189.014606</td>
      <td>6.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>2</th>
      <td>admin.</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>dec</td>
      <td>success</td>
      <td>mid</td>
      <td>34.631865</td>
      <td>2676.180974</td>
      <td>1068.200258</td>
      <td>1.014127</td>
      <td>182.010006</td>
      <td>6.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>3</th>
      <td>admin.</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>dec</td>
      <td>success</td>
      <td>mid</td>
      <td>35.280412</td>
      <td>2192.127338</td>
      <td>607.713537</td>
      <td>1.499062</td>
      <td>170.209898</td>
      <td>6.0</td>
      <td>yes</td>
    </tr>
    <tr>
      <th>4</th>
      <td>admin.</td>
      <td>married</td>
      <td>secondary</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>cellular</td>
      <td>dec</td>
      <td>success</td>
      <td>mid</td>
      <td>35.335524</td>
      <td>2257.501848</td>
      <td>1436.361721</td>
      <td>1.449015</td>
      <td>166.697277</td>
      <td>6.0</td>
      <td>yes</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-79659ecc-77ce-42ef-ac0f-65a63a9fe005')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-79659ecc-77ce-42ef-ac0f-65a63a9fe005 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-79659ecc-77ce-42ef-ac0f-65a63a9fe005');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-1b8732e2-acc8-458d-a96b-86dc18c31fd8">
  <button class="colab-df-quickchart" onclick="quickchart('df-1b8732e2-acc8-458d-a96b-86dc18c31fd8')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-1b8732e2-acc8-458d-a96b-86dc18c31fd8 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>



