---
layout: single
title: "Using Anchor method on an image"
categories: XAI
sidebar: true
use_math: true
---


# ë¬¸ì œ: ê´€ì‹¬ìˆëŠ” ì‚¬ì§„ì— ëŒ€í•˜ì—¬ anchors êµ¬í•˜ê¸°


```python
import tensorflow as tf 
import matplotlib 
%matplotlib inline
import matplotlib.pyplot as plt 
import numpy as np 
from tensorflow.keras.applications.inception_v3 import InceptionV3, preprocess_input, decode_predictions 
from alibi.explainers import AnchorImage
from PIL import Image
```

## 1. ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
ë‹¤ìŒ ì´ë¯¸ì§€ëŠ” ê³ ì–‘ì´ ì²´ë¦¬ê°€ ì£¼ë°© ì˜¤ë¸í† ìŠ¤í„° ìœ„ì— ì•‰ì•„ ìˆëŠ” ì‚¬ì§„ì´ë‹¤. Keras ê³µì‹ë¬¸ì„œì— ì˜í•˜ë©´ InceptionV3 ì¸ìŠ¤í„´ìŠ¤í™” ì‹œ include_top íŒŒë¼ë¯¸í„°ë¥¼ Trueë¡œ ì§€ì •í•  ê²½ìš°, input shapeì€ (299, 299, 3)ì´ì–´ì•¼ í•œë‹¤. ë•Œë¬¸ì— ì´ë¯¸ì§€ í¬ê¸°ë¥¼ (299, 299)ë¡œ resize í•˜ì˜€ë‹¤. 



```python
img = Image.open('cherry3.jpeg')
image = img.resize((299, 299))
image = tf.convert_to_tensor(image)
print(image)

plt.imshow(image)

```

    tf.Tensor(
    [[[173 133 107]
      [171 132 105]
      [169 132 105]
      ...
      [192 189 184]
      [192 188 186]
      [194 189 186]]
    
     [[171 131 105]
      [172 132 106]
      [169 132 105]
      ...
      [191 188 183]
      [192 188 185]
      [194 189 186]]
    
     [[169 129 103]
      [170 130 104]
      [171 131 105]
      ...
      [193 189 185]
      [194 189 186]
      [193 188 185]]
    
     ...
    
     [[ 77  64  57]
      [ 84  70  62]
      [ 84  73  65]
      ...
      [196 179 153]
      [197 180 154]
      [195 178 152]]
    
     [[ 78  63  57]
      [ 85  70  61]
      [ 87  75  66]
      ...
      [196 179 153]
      [198 181 155]
      [197 180 154]]
    
     [[ 78  62  57]
      [ 85  68  60]
      [ 87  74  65]
      ...
      [194 177 151]
      [196 179 153]
      [198 181 155]]], shape=(299, 299, 3), dtype=uint8)





    <matplotlib.image.AxesImage at 0x33a1065e0>




    
![png](/images/m4/a2_2/output_3_2.png)
    


## 2. InceptionV3 ëª¨í˜• í†µê³¼
- tf.kerasì—ì„œ ì´ë¯¸ì§€ ë°ì´í„°ëŠ” 4D tensorë¡œ ì…ë ¥í•´ì•¼ í•˜ë¯€ë¡œ (1, 299, 299, 3)ìœ¼ë¡œ reshape í•œë‹¤.
- InceptionV3ë¥¼ v3ë¡œ ê°ì²´í™” í•˜ê³ , í•¨ìˆ˜í˜• APIë¡œ ì…ë ¥ì¸µ(inputs=input_image)ê³¼ ì¶œë ¥ì¸µ(outputs=x)ì„ ì§€ì •í•˜ì—¬ ë”¥ëŸ¬ë‹ ëª¨ë¸ì„ ì •ì˜í•˜ì˜€ë‹¤. 

  tf.keras.Model í´ë˜ìŠ¤ ê°ì²´ì˜ ë¦¬í„´ê°’ì´ â€œNumpy array(s) of predictionsâ€ì´ê¸° ë•Œë¬¸ì— predsì— Numpyì˜ í•¨ìˆ˜ì¸ argsortë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. argsortëŠ” arrayë¥¼ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ëŠ” ì¸ë±ìŠ¤ë¥¼ ë°˜í™˜í•œë‹¤. ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•˜ë©´ predsë¥¼ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ í›„ ë°‘ì—ì„œë¶€í„°(ì¦‰ ê°€ì¥ í™•ë¥ ì´ ë†’ì€) í•­ëª©ì„ 5ê°œ ì¶œë ¥í•œë‹¤. ì¸í„°ë„·ì—ì„œ â€œimagenet label listâ€ë¥¼ ê²€ìƒ‰í•˜ë©´ 1000ê°œ í´ë˜ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ì¸ë±ìŠ¤ì™€ ì„¤ëª…ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì…ë ¥í•œ ì´ë¯¸ì§€ë¡œë¶€í„° 284ë²ˆ ë ˆì´ë¸”(siamese cat)ì´ 78.4% í™•ë¥ ë¡œ ê°€ì¥ ë†’ê²Œ ì˜ˆì¸¡ë˜ì—ˆê³ (ì²´ë¦¬ëŠ” ê·€ì—¬ìš´ ìƒ´ê³ ì–‘ì´ë‹¤), ë‹¤ìŒìœ¼ë¡œ 811ë²ˆ(space heater)ê³¼ 859ë²ˆ(toaster)ì´ ê°ê° 8.1%, 1.0% í™•ë¥ ë¡œ ì˜ˆì¸¡ë˜ì—ˆë‹¤. 


```python
image = np.reshape(image, (1, 299, 299, 3))

v3 = tf.keras.applications.inception_v3.InceptionV3(include_top=True, weights='imagenet')

input_image = tf.keras.Input([None, None, 3])
x = input_image
x = tf.keras.applications.inception_v3.preprocess_input(x)
x = v3(x)

model = tf.keras.Model(inputs=input_image, outputs = x)
preds = model.predict(image)

# ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ í›„ ë°‘ì—ì„œë¶€í„° 5ê°œ êº¼ë‚´ìš¤: ê°€ì¥ í™•ë¥ ì´ ë†’ì€ 5ê°œ ë ˆì´ë¸” 
for item in preds.argsort()[0][-5:]:
    print(item, preds[0, item])
    
# 284 >>>>> 811 space heater > 859 toaster ìˆœìœ¼ë¡œ í™•ë¥ ì´ ë†’ë‹¤ 
```

    [1m1/1[0m [32mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m[37m[0m [1m1s[0m 847ms/step
    753 0.0053976285
    588 0.0071097505
    859 0.010117765
    811 0.08143277
    284 0.784123



```python
plt.imshow(image[0])
```




    <matplotlib.image.AxesImage at 0x340ab8040>




    
![png](/images/m4/a2_2/output_7_1.png)
    


## 3. anchors ì°¾ê¸°
anchorsë¥¼ ì°¾ê¸° ìœ„í•œ image_shapeì„ ì…ë ¥ ì´ë¯¸ì§€ì™€ ë™ì¼í•œ (299, 299, 3)ìœ¼ë¡œ ì •ì˜í•œë‹¤. ì˜ˆì¸¡í•¨ìˆ˜ë¡œëŠ” ëŒë‹¤ì‹ìœ¼ë¡œ ì •ì˜í•œ InceptionV3 ëª¨ë¸ ê°ì²´ì˜ predictë¥¼ ì§€ì •í•œë‹¤. segmentation_fnìœ¼ë¡œëŠ” ë‚´ì¥ super-pixel ì¤‘ í•˜ë‚˜ì¸ â€˜slicâ€™ì„ ì‚¬ìš©í•œë‹¤. 


```python
image_shape = (299, 299, 3)
predict_fn = lambda x: model.predict(x)
explainer = AnchorImage(predictor=predict_fn,
                        image_shape=image_shape,
                        segmentation_fn='slic',
                        images_background=None)
```

    [1m1/1[0m [32mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m[37m[0m [1m1s[0m 776ms/step


ì•„ë˜ í”„ë¡œê·¸ë¨ì„ í†µí•´ ì…ë ¥ì´ë¯¸ì§€ì˜ super-pixel anchorsë¥¼ êµ¬í•˜ì—¬ ì‹œê°í™” í•œë‹¤.
- `threshold`: $P(prec(A) \ge t) \ge 1 - \delta$ ì—ì„œ `A`ê°€ Anchorì¼ ë•Œ, `t`ë¥¼ ì˜ë¯¸í•œë‹¤
- `p_sample`: super-pixelì„ ì„ì˜ë¡œ ë½‘ì•„ 1ê°’ì„ ë¶€ì—¬í•˜ê³ (on) ë½‘íˆì§€ ì•Šì€ super-pixelì€ 0ê°’ì„ ë¶€ì—¬(off)í•˜ëŠ” ì‹œë®¬ë ˆì´ì…˜ì—ì„œ off í•  super-pixelì˜ ë¹„ìœ¨ì„ ì§€ì •í•œë‹¤
    - ì´ë¯¸ì§€ ë°ì´í„°ì˜ íŠ¹ì„±ë³€ìˆ˜ëŠ” í”½ì…€ì´ë¯€ë¡œ ë¸”ë™ë°•ìŠ¤ ëª¨í˜•ì— ì…ë ¥ë˜ëŠ” íŠ¹ì„±ë³€ìˆ˜ì˜ ìˆ˜ëŠ” ë§¤ìš° ë§ì§€ë§Œ, í”½ì…€ í•˜ë‚˜ê°€ ì˜ˆì¸¡ì¹˜ì— ëŒ€í•´ ê°€ì§€ëŠ” ê¸°ì—¬ë„ëŠ” ë§¤ìš° ì ë‹¤. 
    - ì´ëŸ¬í•œ ì´ìœ ë¡œ í”½ì…€ì˜ ê·¸ë£¹í™”ì¸ super-pixelë¡œ ìœ ë¦¬ìƒì ëª¨í˜•ì˜ í•©ì„±íŠ¹ì„±ë³€ìˆ˜ë¥¼ ìƒì„±í•˜ê²Œ ëœë‹¤. 
    - super-pixelì€ ì´ë¯¸ì§€ ë‚´ ê°ì²´ ê°„ ì˜ë¯¸ìˆëŠ” ê²½ê³„ì„ ì„ ì°¾ì•„ í”½ì…€ì„ ê·¸ë£¹í™” í•œ ê²ƒì´ë‹¤.
    - ëŒ€ë¦¬ëª¨í˜•ì˜ í•©ì„±íŠ¹ì„±ë³€ìˆ˜ëŠ” super-pixelì„ ì„ì˜ë¡œ ë½‘ì•„ 1ê°’ì„ ë¶€ì—¬í•˜ê³  ë½‘íˆì§€ ì•Šì€ super-pixelì€ ì´ë¯¸ì§€ì—ì„œ ì œê±°(0ê°’ì„ ë¶€ì—¬)í•œë‹¤.
- `tau`: $P(prec(A) \ge prec(A^*) - \tau) \ge 1 - \delta$

ì•„ë˜ ê·¸ë¦¼ì„ í†µí•´ ê³ ì–‘ì´ ì–¼êµ´ì„ í¬í•¨í•˜ëŠ” super-pixelì´ anchorì„ì„ ì•Œ ìˆ˜ ìˆë‹¤. ìœ„ì—ì„œ AnchorImageë¥¼ ì¸ìŠ¤í„´ìŠ¤í™” í•  ë•Œ images_background=Noneìœ¼ë¡œ ì§€ì •í•˜ì—¬ anchor super-pixelë¥¼ ì œì™¸í•œ ë¶€ë¶„ì€ ê²€ì •ìƒ‰ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ê³  ìˆë‹¤.  


```python
np.random.seed(0)
explanation = explainer.explain(image[0], threshold=.90, p_sample=.5)
plt.imshow(explanation.anchor)
```

    [1m1/1[0m [32mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m[37m[0m [1m0s[0m 59ms/step
    [1m4/4[0m [32mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m[37m[0m [1m4s[0m 778ms/step
    [1m4/4[0m [32mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[0m[37m[0m [1m3s[0m 777ms/step





    <matplotlib.image.AxesImage at 0x3378e1f10>




    
![png](/images/m4/a2_2/output_11_2.png)
    


ì•„ë˜ ê·¸ë¦¼ì€ segmentation function ì¤‘ ìœ„ì—ì„œ ì‚¬ìš©í•œ â€˜slicâ€™ì— ì˜í•œ super-pixelì„ ë³´ì—¬ì£¼ê³  ìˆë‹¤. ê³ ì–‘ì´, ì˜¤ë¸í† ìŠ¤í„°, ìœ ë¦¬ë³‘ ë“± í”¼ì‚¬ì²´ì˜ ìœ¤ê³½ì„ ì„ ì¤‘ì‹¬ìœ¼ë¡œ super-pixelì´ êµ¬ì„±ë˜ì–´ ìˆë‹¤. 


```python
plt.imshow(explanation.segments)
```




    <matplotlib.image.AxesImage at 0x33ef045b0>




    
![png](/images/m4/a2_2/output_13_1.png)
    

